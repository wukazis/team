<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é‚€è¯·ç é¢†å–</title>
    <style>
        :root {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            font-size: 14px;
            line-height: 1.6;
            color: #0f172a;
            --bg: #f6f7f9;
            --card: #ffffff;
            --border: #e5e7eb;
            --text: #0f172a;
            --muted: #64748b;
            --primary: #2563eb;
            --primary-hover: #1d4ed8;
            --danger: #dc2626;
            --success: #16a34a;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { background: var(--bg); min-height: 100vh; }
        .navbar {
            background: var(--card);
            border-bottom: 1px solid var(--border);
            padding: 0.8rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .navbar-brand {
            font-weight: 600;
            font-size: 1.1rem;
            color: var(--text);
            text-decoration: none;
        }
        .navbar-link {
            color: var(--muted);
            text-decoration: none;
            font-size: 0.9rem;
        }
        .navbar-link:hover { color: var(--primary); }
        .page {
            width: min(900px, 94%);
            margin: 1.5rem auto;
            padding-bottom: 3rem;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
        .card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 1px 3px rgba(15, 23, 42, 0.06);
        }
        .card h2 {
            font-size: 1.2rem;
            margin-bottom: 1rem;
        }
        
        /* è½¦ä½çŠ¶æ€ - åŸç‰ˆé£æ ¼ */
        .team-accounts-dashboard {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        .dashboard-row {
            display: flex;
            align-items: center;
            gap: 1.5rem;
            padding: 1rem 1.25rem;
            border: 2px solid var(--border);
            border-radius: 12px;
            background: #fff;
            cursor: pointer;
            transition: all 0.2s;
        }
        .dashboard-row:hover:not(.full) {
            border-color: var(--primary);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .dashboard-row.selected {
            border-color: var(--primary);
            background: #f0f7ff;
        }
        .dashboard-row.full {
            opacity: 0.6;
            cursor: not-allowed;
        }
        .dashboard-name {
            font-weight: 600;
            font-size: 1.1rem;
            min-width: 120px;
            flex-shrink: 0;
        }
        .dashboard-gauges {
            display: flex;
            align-items: center;
            gap: 1.25rem;
            flex-wrap: wrap;
        }
        .gauge {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.25rem;
        }
        .gauge svg {
            width: 50px;
            height: 50px;
            transform: rotate(-90deg);
        }
        .gauge-bg {
            fill: none;
            stroke: #e5e7eb;
            stroke-width: 3;
        }
        .gauge-fill {
            fill: none;
            stroke-width: 3;
            stroke-linecap: round;
            transition: stroke-dasharray 0.3s;
        }
        .gauge-fill.used { stroke: #f59e0b; }
        .gauge-fill.pending { stroke: #8b5cf6; }
        .gauge-fill.total { stroke: #3b82f6; }
        .gauge-fill.available { stroke: #10b981; }
        .gauge-fill.empty { stroke: #ef4444; }
        .gauge-text {
            fill: var(--text);
            font-size: 10px;
            font-weight: 600;
            text-anchor: middle;
            transform: rotate(90deg);
            transform-origin: center;
        }
        .gauge-label {
            font-size: 0.7rem;
            color: var(--muted);
        }
        
        /* é‚€è¯·ç è¡¨å• */
        .invite-card {
            max-width: 600px;
            margin: 0 auto;
            width: 100%;
        }
        .invite-card h1 {
            font-size: 1.4rem;
            text-align: center;
            margin-bottom: 0.5rem;
        }
        .invite-card .subtitle {
            color: var(--muted);
            text-align: center;
            margin-bottom: 1.5rem;
        }
        .form-group {
            margin-bottom: 1rem;
        }
        .form-group label {
            display: block;
            margin-bottom: 0.4rem;
            font-weight: 500;
        }
        .form-group input, .form-group select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border);
            border-radius: 10px;
            font-size: 1rem;
            background: #fff;
            color: var(--text);
            transition: border-color 0.15s, box-shadow 0.15s;
        }
        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }
        .btn {
            border-radius: 8px;
            padding: 0.75rem 1.2rem;
            font-weight: 600;
            font-size: 1rem;
            border: none;
            cursor: pointer;
            transition: background 0.15s;
            width: 100%;
        }
        .btn-primary {
            background: var(--primary);
            color: #fff;
        }
        .btn-primary:hover:not(:disabled) { background: var(--primary-hover); }
        .btn-primary:disabled { opacity: 0.55; cursor: not-allowed; }
        .btn-muted {
            background: #f1f5f9;
            color: var(--text);
            border: 1px solid var(--border);
        }
        .message {
            margin-top: 1rem;
            padding: 1rem;
            border-radius: 10px;
            text-align: center;
            font-weight: 500;
        }
        .message.success { background: #f0fdf4; color: var(--success); border: 1px solid #dcfce7; }
        .message.error { background: #fef2f2; color: var(--danger); border: 1px solid #fecaca; }
        .success-box {
            background: #f0fdf4;
            border: 1px solid #dcfce7;
            border-radius: 10px;
            padding: 1.5rem;
            text-align: center;
        }
        .success-box h2 { font-size: 1.1rem; margin-bottom: 0.5rem; color: var(--success); }
        .success-box .email { font-size: 1.2rem; font-weight: 600; margin-bottom: 1rem; }
        .muted { color: var(--muted); font-size: 0.9rem; }
        .hidden { display: none !important; }
        .loading { text-align: center; padding: 2rem; color: var(--muted); }
    </style>
</head>
<body>
    <nav class="navbar">
        <a href="/" class="navbar-brand">ğŸ« Team Invite</a>
        <a href="/admin" class="navbar-link">ç®¡ç†åå°</a>
    </nav>

    <main class="page">
        <!-- è½¦ä½çŠ¶æ€ -->
        <section class="card">
            <h2>ğŸš— è½¦ä½çŠ¶æ€</h2>
            <div id="teamAccountsContainer" class="loading">åŠ è½½ä¸­...</div>
        </section>

        <!-- é‚€è¯·ç è¡¨å• -->
        <section class="card invite-card">
            <h1>é‚€è¯·ç é¢†å–</h1>
            <p class="subtitle">è¾“å…¥é‚€è¯·ç å’Œé‚®ç®±å®Œæˆé¢†å–</p>
            
            <div id="formSection">
                <form id="inviteForm">
                    <div class="form-group">
                        <label for="code">é‚€è¯·ç </label>
                        <input type="text" id="code" placeholder="è¯·è¾“å…¥é‚€è¯·ç " required autocomplete="off">
                    </div>
                    <div class="form-group">
                        <label for="email">é‚®ç®±åœ°å€</label>
                        <input type="email" id="email" placeholder="you@example.com" required>
                    </div>
                    <div class="form-group" id="teamSelectGroup">
                        <label>é€‰æ‹©è½¦ä½</label>
                        <select id="teamSelect" required>
                            <option value="">è¯·é€‰æ‹©è½¦ä½</option>
                        </select>
                        <p id="lockedHint" class="muted hidden" style="margin-top: 0.3rem;">è¯¥é‚€è¯·ç å·²ç»‘å®šè½¦ä½</p>
                    </div>
                    <button type="submit" class="btn btn-primary" id="submitBtn">å‘é€é‚€è¯·</button>
                </form>
                <div id="message" class="message hidden"></div>
            </div>

            <div id="successSection" class="hidden">
                <div class="success-box">
                    <h2>âœ… å‘é€æˆåŠŸ</h2>
                    <p>é‚€è¯·å·²å‘é€åˆ°</p>
                    <p class="email" id="successEmail"></p>
                    <button class="btn btn-muted" onclick="resetForm()">ç»§ç»­é¢†å–</button>
                </div>
            </div>
        </section>
    </main>

    <script>
        let teamAccounts = [];
        let selectedAccountId = null;
        let lockedTeamAccountId = null;
        let checkTimer = null;

        // åŠ è½½è½¦ä½çŠ¶æ€
        async function loadTeamAccounts() {
            try {
                const res = await fetch('/api/team-accounts/status');
                const data = await res.json();
                teamAccounts = data.accounts || [];
                renderTeamAccounts();
                updateTeamSelect();
            } catch (e) {
                document.getElementById('teamAccountsContainer').innerHTML = '<p class="muted">åŠ è½½å¤±è´¥</p>';
            }
        }

        function renderTeamAccounts() {
            const container = document.getElementById('teamAccountsContainer');
            if (teamAccounts.length === 0) {
                container.innerHTML = '<p class="muted">æš‚æ— å¯ç”¨è½¦ä½</p>';
                return;
            }

            container.innerHTML = '<div class="team-accounts-dashboard">' + teamAccounts.map(acc => {
                const available = acc.seatsEntitled - acc.seatsInUse - acc.pendingInvites;
                const isFull = acc.seatsInUse + acc.pendingInvites >= acc.maxSeats;
                const isSelected = selectedAccountId === acc.id;
                const usedPct = acc.seatsEntitled > 0 ? (acc.seatsInUse / acc.seatsEntitled) * 100 : 0;
                const pendingPct = acc.seatsEntitled > 0 ? (acc.pendingInvites / acc.seatsEntitled) * 100 : 0;
                const availPct = acc.seatsEntitled > 0 ? (available / acc.seatsEntitled) * 100 : 0;

                return `
                <div class="dashboard-row ${isSelected ? 'selected' : ''} ${isFull ? 'full' : ''}" 
                     onclick="selectAccount(${acc.id}, ${isFull})">
                    <div class="dashboard-name">${acc.name}</div>
                    <div class="dashboard-gauges">
                        ${renderGauge(acc.seatsInUse, usedPct, 'used', 'å·²ç”¨')}
                        ${renderGauge(acc.pendingInvites, pendingPct, 'pending', 'å¾…å¤„ç†')}
                        ${renderGauge(acc.seatsEntitled, 100, 'total', 'æ€»å¸­ä½')}
                        ${renderGauge(available, availPct, isFull ? 'empty' : 'available', 'å‰©ä½™')}
                    </div>
                </div>`;
            }).join('') + '</div>';
        }

        function renderGauge(value, pct, type, label) {
            return `
            <div class="gauge">
                <svg viewBox="0 0 36 36">
                    <path class="gauge-bg" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"/>
                    <path class="gauge-fill ${type}" stroke-dasharray="${pct}, 100" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"/>
                    <text x="18" y="20.5" class="gauge-text">${value}</text>
                </svg>
                <span class="gauge-label">${label}</span>
            </div>`;
        }

        function selectAccount(id, isFull) {
            if (isFull || lockedTeamAccountId) return;
            selectedAccountId = id;
            renderTeamAccounts();
            document.getElementById('teamSelect').value = id;
        }

        function updateTeamSelect() {
            const select = document.getElementById('teamSelect');
            select.innerHTML = '<option value="">è¯·é€‰æ‹©è½¦ä½</option>' + 
                teamAccounts.map(acc => {
                    const busy = acc.seatsInUse + acc.pendingInvites >= acc.maxSeats;
                    return `<option value="${acc.id}" ${busy ? 'disabled' : ''}>
                        ${acc.name} (${acc.seatsInUse + acc.pendingInvites}/${acc.seatsEntitled}) ${busy ? '(å·²æ»¡)' : ''}
                    </option>`;
                }).join('');
            
            if (selectedAccountId) {
                select.value = selectedAccountId;
            } else if (teamAccounts.length > 0) {
                const available = teamAccounts.find(a => a.seatsInUse + a.pendingInvites < a.maxSeats);
                if (available) {
                    selectedAccountId = available.id;
                    select.value = available.id;
                }
            }
        }

        // æ£€æŸ¥é‚€è¯·ç 
        async function checkInviteCode(code) {
            if (!code) {
                lockedTeamAccountId = null;
                document.getElementById('lockedHint').classList.add('hidden');
                document.getElementById('teamSelect').disabled = false;
                return;
            }
            try {
                const res = await fetch('/api/invite/check', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ code })
                });
                const data = await res.json();
                if (res.ok && data.teamAccountId) {
                    lockedTeamAccountId = data.teamAccountId;
                    selectedAccountId = data.teamAccountId;
                    document.getElementById('teamSelect').value = data.teamAccountId;
                    document.getElementById('teamSelect').disabled = true;
                    document.getElementById('lockedHint').classList.remove('hidden');
                    renderTeamAccounts();
                } else {
                    lockedTeamAccountId = null;
                    document.getElementById('teamSelect').disabled = false;
                    document.getElementById('lockedHint').classList.add('hidden');
                }
            } catch (e) {}
        }

        // è¡¨å•å¤„ç†
        const form = document.getElementById('inviteForm');
        const codeInput = document.getElementById('code');
        const message = document.getElementById('message');
        const submitBtn = document.getElementById('submitBtn');

        codeInput.addEventListener('input', () => {
            clearTimeout(checkTimer);
            checkTimer = setTimeout(() => checkInviteCode(codeInput.value.trim()), 300);
        });

        document.getElementById('teamSelect').addEventListener('change', (e) => {
            if (!lockedTeamAccountId) {
                selectedAccountId = parseInt(e.target.value) || null;
                renderTeamAccounts();
            }
        });

        function showMessage(text, isError = false) {
            message.textContent = text;
            message.className = 'message ' + (isError ? 'error' : 'success');
            message.classList.remove('hidden');
        }

        function resetForm() {
            document.getElementById('formSection').classList.remove('hidden');
            document.getElementById('successSection').classList.add('hidden');
            form.reset();
            message.classList.add('hidden');
            lockedTeamAccountId = null;
            document.getElementById('teamSelect').disabled = false;
            document.getElementById('lockedHint').classList.add('hidden');
            loadTeamAccounts();
        }

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const code = codeInput.value.trim();
            const email = document.getElementById('email').value.trim();
            const teamAccountId = lockedTeamAccountId || selectedAccountId;

            if (!teamAccountId) {
                showMessage('è¯·é€‰æ‹©è½¦ä½', true);
                return;
            }

            submitBtn.disabled = true;
            submitBtn.textContent = 'å‘é€ä¸­...';
            message.classList.add('hidden');

            try {
                const res = await fetch('/api/invite/use', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ code, email, teamAccountId })
                });
                const data = await res.json();

                if (res.ok) {
                    document.getElementById('formSection').classList.add('hidden');
                    document.getElementById('successSection').classList.remove('hidden');
                    document.getElementById('successEmail').textContent = email;
                    loadTeamAccounts();
                } else {
                    showMessage(data.error || 'æäº¤å¤±è´¥', true);
                }
            } catch (err) {
                showMessage('ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•', true);
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'å‘é€é‚€è¯·';
            }
        });

        // åˆå§‹åŒ– & å®šæ—¶åˆ·æ–°
        loadTeamAccounts();
        setInterval(loadTeamAccounts, 5000);
    </script>
</body>
</html>
