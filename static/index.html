<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>邀请码领取</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='50' cy='50' r='45' fill='%232563eb' stroke='%231d4ed8' stroke-width='4'/><text x='50' y='68' font-size='50' font-weight='bold' fill='white' text-anchor='middle' font-family='Arial'>W</text></svg>">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>
    <script src="https://js.hcaptcha.com/1/api.js?onload=onHcaptchaLoad&render=explicit" async defer></script>
    <style>
        :root {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            font-size: 14px;
            line-height: 1.6;
            color: #0f172a;
            --bg: #f1f5f9;
            --card: #ffffff;
            --border: #e5e7eb;
            --text: #0f172a;
            --muted: #64748b;
            --primary: #2563eb;
            --primary-hover: #1d4ed8;
            --danger: #dc2626;
            --success: #16a34a;
            --hover-bg: #f1f5f9;
        }
        [data-theme="dark"] {
            --bg: #0f172a;
            --card: #1e293b;
            --border: #334155;
            --text: #f1f5f9;
            --muted: #94a3b8;
            --hover-bg: #334155;
        }
        [data-theme="dark"] .message.success { background: rgba(22, 163, 74, 0.15); border-color: rgba(22, 163, 74, 0.3); }
        [data-theme="dark"] .message.error { background: rgba(220, 38, 38, 0.15); border-color: rgba(220, 38, 38, 0.3); }
        [data-theme="dark"] .success-box { background: rgba(22, 163, 74, 0.15); border-color: rgba(22, 163, 74, 0.3); }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { background: var(--bg); min-height: 100vh; color: var(--text); }
        .navbar {
            background: var(--card);
            border-bottom: 1px solid var(--border);
            padding: 0.8rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 50;
        }
        .navbar-brand {
            font-weight: 600;
            font-size: 1.1rem;
            color: var(--text);
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .navbar-right {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        .navbar-link {
            color: var(--muted);
            text-decoration: none;
            font-size: 0.9rem;
        }
        .navbar-link:hover { color: var(--primary); }
        .user-info {
            position: relative;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
        }
        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid var(--border);
            transition: border-color 0.2s;
        }
        .user-avatar:hover { border-color: var(--primary); }
        .user-card {
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%) translateY(-10px);
            margin-top: 0.5rem;
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 0.75rem;
            min-width: 140px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s ease;
            z-index: 100;
            text-align: center;
        }
        .user-info:hover .user-card {
            opacity: 1;
            visibility: visible;
            transform: translateX(-50%) translateY(0);
        }
        .user-card-name { font-weight: 600; font-size: 0.95rem; color: var(--text); }
        .user-card-username { color: var(--muted); font-size: 0.8rem; margin-top: 2px; }
        .user-card-meta { color: var(--muted); font-size: 0.75rem; margin-top: 0.5rem; padding-top: 0.5rem; border-top: 1px solid var(--border); }
        .user-card-logout { 
            display: block; 
            width: 100%; 
            margin-top: 0.6rem; 
            padding: 0.5rem; 
            background: var(--bg); 
            border: 1px solid var(--border); 
            border-radius: 6px; 
            cursor: pointer; 
            color: var(--text);
            text-align: center;
            font-size: 0.8rem;
        }
        .user-card-logout:hover { background: var(--border); }
        .page {
            width: min(420px, 94%);
            margin: 1.5rem auto;
            padding-bottom: 3rem;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
        .card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 1px 3px rgba(15, 23, 42, 0.06);
        }
        .card h2 {
            font-size: 1.1rem;
            margin-bottom: 0.75rem;
            color: var(--primary);
        }
        
        /* 登录卡片 - 居中显示 */
        .login-center {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            background: var(--bg);
            z-index: 100;
        }
        .login-card {
            max-width: 380px;
            width: 90%;
            text-align: center;
            padding: 2rem;
        }
        .login-card h2 {
            font-size: 1.3rem;
            margin-bottom: 0.5rem;
            color: var(--text);
        }
        .login-card p {
            color: var(--muted);
            margin-bottom: 1.5rem;
        }
        .btn-linuxdo {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            background: #f97316;
            color: #fff;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            font-size: 1rem;
            border: none;
            cursor: pointer;
            transition: background 0.15s;
            width: 100%;
        }
        .btn-linuxdo:hover { background: #ea580c; }
        .btn-linuxdo svg { width: 20px; height: 20px; flex-shrink: 0; }
        
        /* 车位状态 */
        .team-accounts-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        .team-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem 1rem;
            border: 2px solid var(--border);
            border-radius: 10px;
            background: var(--card);
            cursor: pointer;
            transition: all 0.15s;
        }
        .team-row:hover:not(.full) {
            border-color: var(--primary);
        }
        .team-row.selected {
            border-color: var(--primary);
            background: var(--hover-bg);
        }
        .team-row.full {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .team-name {
            font-weight: 600;
            font-size: 0.95rem;
        }
        .team-info {
            display: flex;
            align-items: center;
            gap: 1rem;
            font-size: 0.85rem;
            color: var(--muted);
        }
        .team-stat {
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }
        .team-stat.available { color: var(--success); font-weight: 600; }
        .team-stat.full { color: var(--danger); }
        
        /* 邀请码表单 */
        .invite-card h1 {
            font-size: 1.2rem;
            text-align: center;
            margin-bottom: 0.5rem;
            color: var(--text);
        }
        .invite-card .subtitle {
            color: var(--muted);
            text-align: center;
            margin-bottom: 1.5rem;
            font-size: 0.9rem;
        }
        .form-group {
            margin-bottom: 1rem;
        }
        .form-group label {
            display: block;
            margin-bottom: 0.4rem;
            font-weight: 500;
            font-size: 0.9rem;
        }
        .form-group input, .form-group select {
            width: 100%;
            padding: 0.7rem;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 0.95rem;
            background: var(--card);
            color: var(--text);
            transition: border-color 0.15s, box-shadow 0.15s;
        }
        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }
        .turnstile-wrapper {
            margin-bottom: 1rem;
            width: 100%;
        }
        .turnstile-wrapper iframe {
            width: 100% !important;
        }
        .btn {
            border-radius: 8px;
            padding: 0.7rem 1.2rem;
            font-weight: 600;
            font-size: 0.95rem;
            border: none;
            cursor: pointer;
            transition: background 0.15s;
            width: 100%;
        }
        .btn-primary {
            background: var(--primary);
            color: #fff;
        }
        .btn-primary:hover:not(:disabled) { background: var(--primary-hover); }
        .btn-primary:disabled { opacity: 0.55; cursor: not-allowed; }
        .message {
            margin-top: 1rem;
            padding: 0.75rem;
            border-radius: 8px;
            text-align: center;
            font-size: 0.9rem;
        }
        .message.success { background: #f0fdf4; color: var(--success); border: 1px solid #dcfce7; }
        .message.error { background: #fef2f2; color: var(--danger); border: 1px solid #fecaca; }
        .success-box {
            background: #f0fdf4;
            border: 1px solid #dcfce7;
            border-radius: 10px;
            padding: 1.5rem;
            text-align: center;
        }
        .success-box h2 { font-size: 1.1rem; margin-bottom: 0.5rem; color: var(--success); }
        .success-box .email { font-size: 1.1rem; font-weight: 600; }
        .muted { color: var(--muted); font-size: 0.85rem; }
        .hidden { display: none !important; }
        
        /* 加载动画 */
        .loading-overlay {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: var(--bg);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.3s ease;
        }
        .loading-overlay.fade-out { opacity: 0; pointer-events: none; }
        .logo-container { width: 60px; height: 60px; }
        .tech-stroke {
            fill: none;
            stroke: var(--primary);
            stroke-width: 2;
            stroke-linecap: round;
            filter: drop-shadow(0 0 2px var(--primary));
        }
        .ring-group { transform-origin: 50px 50px; animation: spin 2s linear infinite; }
        .draw-path { stroke-dasharray: 100; stroke-dashoffset: 100; animation: draw 0.8s ease-out forwards; }
        .center-circle { animation: pop 0.3s ease forwards 0.5s; opacity: 0; transform-origin: 50px 50px; fill: var(--bg); }
        @keyframes draw { to { stroke-dashoffset: 0; } }
        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes pop { to { opacity: 1; } }
        .hourglass-spin { animation: hourglass-flip 3s ease-in-out infinite; }
        @keyframes hourglass-flip { 
            0% { transform: rotate(0deg); }
            66.67% { transform: rotate(180deg); }
            100% { transform: rotate(180deg); }
        }
        
        /* 班车表侧边栏 */
        .schedule-sidebar {
            position: fixed;
            right: 20px;
            top: 220px;
            width: 200px;
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            z-index: 100;
            cursor: move;
            user-select: none;
        }
        .schedule-sidebar.dragging {
            opacity: 0.9;
            box-shadow: 0 4px 16px rgba(0,0,0,0.2);
        }
        .schedule-sidebar h3 {
            font-size: 0.95rem;
            color: var(--primary);
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: move;
        }
        .schedule-item {
            padding: 0.5rem 0;
            border-bottom: 1px solid var(--border);
        }
        .schedule-item:last-child {
            border-bottom: none;
        }
        .schedule-time {
            font-weight: 600;
            font-size: 1rem;
        }
        .schedule-countdown {
            font-size: 0.8rem;
            color: var(--primary);
            margin-top: 0.25rem;
        }
        .schedule-empty {
            color: var(--muted);
            font-size: 0.85rem;
            text-align: center;
            padding: 1rem 0;
        }
        @media (max-width: 900px) {
            .schedule-sidebar, .online-sidebar {
                display: none;
            }
        }
        
        /* 在线用户侧边栏 */
        .online-sidebar {
            position: fixed;
            right: 20px;
            top: 400px;
            width: 200px;
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            z-index: 100;
            max-height: 300px;
            overflow: hidden;
        }
        .online-sidebar h3 {
            font-size: 0.95rem;
            color: var(--primary);
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .online-users-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            max-height: 220px;
            overflow-y: auto;
        }
        .online-user-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.4rem;
            border-radius: 6px;
            transition: background 0.15s;
        }
        .online-user-item:hover {
            background: var(--hover-bg);
        }
        .online-user-avatar {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            object-fit: cover;
            flex-shrink: 0;
        }
        .online-user-name {
            font-size: 0.85rem;
            color: var(--text);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            flex: 1;
        }
        .online-dot {
            width: 8px;
            height: 8px;
            background: var(--success);
            border-radius: 50%;
            flex-shrink: 0;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
</head>
<body>
    <!-- 加载动画 -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="logo-container">
            <svg viewBox="0 0 100 100">
                <defs><path id="petal" d="M40,22 L60,22 L62,24 L60,26 L40,26 L38,24 Z" /></defs>
                <g class="ring-group">
                    <use href="#petal" class="tech-stroke draw-path" transform="rotate(0, 50, 50)" />
                    <use href="#petal" class="tech-stroke draw-path" transform="rotate(60, 50, 50)" style="animation-delay:.1s" />
                    <use href="#petal" class="tech-stroke draw-path" transform="rotate(120, 50, 50)" style="animation-delay:.2s" />
                    <use href="#petal" class="tech-stroke draw-path" transform="rotate(180, 50, 50)" style="animation-delay:.3s" />
                    <use href="#petal" class="tech-stroke draw-path" transform="rotate(240, 50, 50)" style="animation-delay:.4s" />
                    <use href="#petal" class="tech-stroke draw-path" transform="rotate(300, 50, 50)" style="animation-delay:.5s" />
                </g>
                <circle class="center-circle tech-stroke" cx="50" cy="50" r="8" stroke-width="2" />
            </svg>
        </div>
    </div>

    <!-- 维护页面 -->
    <div id="maintenancePage" class="hidden" style="min-height: 100vh; display: flex; justify-content: center; align-items: center; background: var(--bg); padding: 2rem; position: fixed; top: 0; left: 0; width: 100%; z-index: 9998;">
        <div style="text-align: center; max-width: 400px;">
            <img src="/remix.png" alt="维护中" style="width: 120px; height: 120px; margin-bottom: 1rem;">
            <h1 id="maintenanceMsg" style="font-size: 1.5rem; margin-bottom: 1rem; color: var(--text);">正在修车，请稍后再来</h1>
            <p id="maintenanceEndTimeText" style="margin-top: 1rem; font-size: 1.1rem;"></p>
            <p style="color: var(--muted); margin-top: 1.5rem; font-size: 0.9rem;">给您带来不便，敬请谅解</p>
        </div>
    </div>

    <!-- 登录卡片 -->
    <div id="loginPanel" class="login-center">
        <section class="card login-card">
            <h2>登录</h2>
            <p>点击下方按钮继续</p>
            <button class="btn-linuxdo" id="loginBtn">
                <svg viewBox="0 0 16 16" fill="none"><path d="m7.44,0s.09,0,.13,0c.09,0,.19,0,.28,0,.14,0,.29,0,.43,0,.09,0,.18,0,.27,0q.12,0,.25,0t.26.08c.15.03.29.06.44.08,1.97.38,3.78,1.47,4.95,3.11.04.06.09.12.13.18.67.96,1.15,2.11,1.3,3.28q0,.19.09.26c0,.15,0,.29,0,.44,0,.04,0,.09,0,.13,0,.09,0,.19,0,.28,0,.14,0,.29,0,.43,0,.09,0,.18,0,.27,0,.08,0,.17,0,.25q0,.19-.08.26c-.03.15-.06.29-.08.44-.38,1.97-1.47,3.78-3.11,4.95-.06.04-.12.09-.18.13-.96.67-2.11,1.15-3.28,1.3q-.19,0-.26.09c-.15,0-.29,0-.44,0-.04,0-.09,0-.13,0-.09,0-.19,0-.28,0-.14,0-.29,0-.43,0-.09,0-.18,0-.27,0-.08,0-.17,0-.25,0q-.19,0-.26-.08c-.15-.03-.29-.06-.44-.08-1.97-.38-3.78-1.47-4.95-3.11q-.07-.09-.13-.18c-.67-.96-1.15-2.11-1.3-3.28q0-.19-.09-.26c0-.15,0-.29,0-.44,0-.04,0-.09,0-.13,0-.09,0-.19,0-.28,0-.14,0-.29,0-.43,0-.09,0-.18,0-.27,0-.08,0-.17,0-.25q0-.19.08-.26c.03-.15.06-.29.08-.44.38-1.97,1.47-3.78,3.11-4.95.06-.04.12-.09.18-.13C4.42.73,5.57.26,6.74.1,7,.07,7.15,0,7.44,0Z" fill="#EFEFEF"/><path d="m1.27,11.33h13.45c-.94,1.89-2.51,3.21-4.51,3.88-1.99.59-3.96.37-5.8-.57-1.25-.7-2.67-1.9-3.14-3.3Z" fill="#FEB005"/><path d="m12.54,1.99c.87.7,1.82,1.59,2.18,2.68H1.27c.87-1.74,2.33-3.13,4.2-3.78,2.44-.79,5-.47,7.07,1.1Z" fill="#1D1D1F"/></svg>
                <span>使用 LinuxDO 继续</span>
            </button>
        </section>
    </div>

    <!-- 班车表侧边栏 -->
    <div id="scheduleSidebar" class="schedule-sidebar">
        <h3>
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                <line x1="16" y1="2" x2="16" y2="6"></line>
                <line x1="8" y1="2" x2="8" y2="6"></line>
                <line x1="3" y1="10" x2="21" y2="10"></line>
            </svg>
            班车表
        </h3>
        <div id="scheduleContent">
            <p class="schedule-empty">暂无班次</p>
        </div>
    </div>

    <!-- 在线用户侧边栏 -->
    <div id="onlineUsersSidebar" class="online-sidebar hidden">
        <h3>
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                <circle cx="9" cy="7" r="4"></circle>
                <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
            </svg>
            在线用户
            <span id="onlineCount" style="margin-left: auto; font-size: 0.8rem; color: var(--success);">0</span>
        </h3>
        <div id="onlineUsersList" class="online-users-list">
            <p class="schedule-empty">暂无在线用户</p>
        </div>
    </div>

    <nav class="navbar">
        <a href="/" class="navbar-brand">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-check-square-fill" viewBox="0 0 16 16">
  <path d="M2 0a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2H2zm10.03 4.97a.75.75 0 0 1 .011 1.05l-3.992 4.99a.75.75 0 0 1-1.08.02L4.324 8.384a.75.75 0 1 1 1.06-1.06l2.094 2.093 3.473-4.425a.75.75 0 0 1 1.08-.022z"/></svg>
             Team Invite</a>
        <div class="navbar-right">
            <div id="shanghaiClock" style="font-size: 0.85rem; color: var(--muted); font-variant-numeric: tabular-nums;"></div>
            <div id="userInfo" class="user-info hidden"></div>
            <button onclick="toggleTheme()" style="background: none; border: 1px solid var(--border); border-radius: 6px; padding: 0.4rem 0.6rem; cursor: pointer; color: var(--text);" id="themeBtn">
                <svg id="themeIcon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
            </button>
        </div>
    </nav>

    <main class="page">
        <!-- 封禁提示 -->
        <div style="text-align: center; padding: 0.75rem; background: rgba(248, 113, 113, 0.1); border: 1px solid rgba(248, 113, 113, 0.3); border-radius: 8px; margin-bottom: 1rem; color: #f87171; font-size: 0.9rem;">
            账号封禁中，有事请联系 <a href="mailto:RDS@rewindcloudf.com" style="color: #f87171; text-decoration: underline;">rds@rewindcloudf.com</a>
        </div>
        
        <!-- 车位状态 -->
        <section id="teamSection" class="card hidden">
            <h2 style="margin-bottom: 0.75rem;"><svg id="teamFilterIcon" width="18" height="18" viewBox="0 0 24 24" fill="var(--success)" style="vertical-align: -2px; margin-right: 4px; cursor: pointer; transition: fill 0.2s;" onclick="toggleTeamFilter()"><path d="M22.2819 9.8211a5.9847 5.9847 0 0 0-.5157-4.9108 6.0462 6.0462 0 0 0-6.5098-2.9A6.0651 6.0651 0 0 0 4.9807 4.1818a5.9847 5.9847 0 0 0-3.9977 2.9 6.0462 6.0462 0 0 0 .7427 7.0966 5.98 5.98 0 0 0 .511 4.9107 6.051 6.051 0 0 0 6.5146 2.9001A5.9847 5.9847 0 0 0 13.2599 24a6.0557 6.0557 0 0 0 5.7718-4.2058 5.9894 5.9894 0 0 0 3.9977-2.9001 6.0557 6.0557 0 0 0-.7475-7.0729zm-9.022 12.6081a4.4755 4.4755 0 0 1-2.8764-1.0408l.1419-.0804 4.7783-2.7582a.7948.7948 0 0 0 .3927-.6813v-6.7369l2.02 1.1686a.071.071 0 0 1 .038.052v5.5826a4.504 4.504 0 0 1-4.4945 4.4944zm-9.6607-4.1254a4.4708 4.4708 0 0 1-.5346-3.0137l.142.0852 4.783 2.7582a.7712.7712 0 0 0 .7806 0l5.8428-3.3685v2.3324a.0804.0804 0 0 1-.0332.0615L9.74 19.9502a4.4992 4.4992 0 0 1-6.1408-1.6464zM2.3408 7.8956a4.485 4.485 0 0 1 2.3655-1.9728V11.6a.7664.7664 0 0 0 .3879.6765l5.8144 3.3543-2.0201 1.1685a.0757.0757 0 0 1-.071 0l-4.8303-2.7865A4.504 4.504 0 0 1 2.3408 7.872zm16.5963 3.8558L13.1038 8.364 15.1192 7.2a.0757.0757 0 0 1 .071 0l4.8303 2.7913a4.4944 4.4944 0 0 1-.6765 8.1042v-5.6772a.79.79 0 0 0-.407-.667zm2.0107-3.0231l-.142-.0852-4.7735-2.7818a.7759.7759 0 0 0-.7854 0L9.409 9.2297V6.8974a.0662.0662 0 0 1 .0284-.0615l4.8303-2.7866a4.4992 4.4992 0 0 1 6.6802 4.66zM8.3065 12.863l-2.02-1.1638a.0804.0804 0 0 1-.038-.0567V6.0742a4.4992 4.4992 0 0 1 7.3757-3.4537l-.142.0805L8.704 5.459a.7948.7948 0 0 0-.3927.6813zm1.0976-2.3654l2.602-1.4998 2.6069 1.4998v2.9994l-2.5974 1.4997-2.6067-1.4997Z"/></svg> <span id="teamFilterLabel" style="color: var(--success); transition: color 0.2s;">可用车位</span></h2>
            <div id="teamAccountsContainer" class="team-accounts-list">
                <p class="muted" style="text-align:center;padding:1rem;">加载中...</p>
            </div>
        </section>

        <!-- 候车室入口 -->
        <section id="waitingEntry" class="card hidden" style="text-align: center;">
            <h2 style="justify-content: center;">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align: -2px; margin-right: 4px;">
                    <circle cx="12" cy="12" r="10"></circle>
                    <polyline points="12 6 12 12 16 14"></polyline>
                </svg>
                候车室
            </h2>
            <!-- 正常状态 -->
            <div id="waitingNormal">
                <p class="muted" style="margin-bottom: 1rem;">查看车位状态，排队等待发放邀请码</p>
                <div id="hcaptchaWidget" style="display: none;"></div>
                <button id="enterWaitingBtn" onclick="enterWaitingRoom()" class="btn btn-primary" style="display: inline-flex; width: auto; align-items: center; gap: 0.4rem;">
                    <svg id="enterWaitingIcon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M22 17H2a3 3 0 0 0 3-3V9a7 7 0 0 1 14 0v5a3 3 0 0 0 3 3zm-8.27 4a2 2 0 0 1-3.46 0"></path>
                    </svg>
                    <svg id="enterWaitingSpinner" class="hidden" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="animation: spin 1s linear infinite;">
                        <circle cx="12" cy="12" r="10" stroke-dasharray="32" stroke-dashoffset="12"></circle>
                    </svg>
                    <span id="enterWaitingText">进入候车室</span>
                </button>
            </div>
            <!-- 候车室关闭状态 -->
            <div id="waitingClosed" class="hidden">
                <p id="waitingClosedText" style="color: #94a3b8; font-weight: 500; margin-bottom: 0.5rem;">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align: -3px; margin-right: 4px;">
                        <circle cx="12" cy="12" r="10"></circle>
                        <line x1="4.93" y1="4.93" x2="19.07" y2="19.07"></line>
                    </svg>
                    候车室暂不开放
                </p>
                <p id="waitingCountdown" style="font-weight: 600; font-size: 1.1rem; transition: color 0.3s;"></p>
                <p id="waitingMaxQueue" class="hidden" style="color: var(--muted); font-size: 0.9rem; margin-top: 0.3rem;"></p>
            </div>
            <!-- 冷却状态 -->
            <div id="waitingCooldown" class="hidden">
                <p style="color: #f59e0b; font-weight: 500; margin-bottom: 0.5rem;">
                    <svg class="hourglass-spin" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align: -3px; margin-right: 4px;">
                        <path d="M5 22h14"></path>
                        <path d="M5 2h14"></path>
                        <path d="M17 22v-4.172a2 2 0 0 0-.586-1.414L12 12l-4.414 4.414A2 2 0 0 0 7 17.828V22"></path>
                        <path d="M7 2v4.172a2 2 0 0 0 .586 1.414L12 12l4.414-4.414A2 2 0 0 0 17 6.172V2"></path>
                    </svg>
                    您在冷却期内，暂时无法访问候车室
                </p>
                <p class="muted">剩余 <strong id="cooldownDaysLeft">-</strong> 天</p>
                <p class="muted">预计 <strong id="cooldownEndDate">-</strong> 后可再进入</p>
            </div>
        </section>

        <!-- 邀请码表单 -->
        <section id="inviteSection" class="card invite-card hidden">
            <h1>填写邀请信息</h1>
            <p class="subtitle">输入邀请码和邮箱完成领取</p>
            
            <div id="formSection">
                <form id="inviteForm">
                    <div class="form-group">
                        <label for="code">邀请码</label>
                        <input type="text" id="code" placeholder="请输入邀请码" required autocomplete="off">
                    </div>
                    <div class="form-group">
                        <label for="email">邮箱地址</label>
                        <input type="email" id="email" placeholder="you@example.com" required>
                    </div>
                    <div class="form-group">
                        <label>选择车位</label>
                        <select id="teamSelect" required>
                            <option value="">请选择车位</option>
                        </select>
                        <p id="lockedHint" class="muted hidden" style="margin-top:0.3rem;">该邀请码已绑定车位</p>
                    </div>
                    <div id="turnstileContainer" class="turnstile-wrapper"></div>
                    <button type="submit" class="btn btn-primary" id="submitBtn">发送邀请</button>
                </form>
                <div id="message" class="message hidden"></div>
            </div>

            <div id="successSection" class="hidden">
                <div class="success-box">
                    <h2>✅ 发送成功</h2>
                    <p>邀请已发送到</p>
                    <p class="email" id="successEmail"></p>
                </div>
            </div>
        </section>

    </main>

    <script>
        let teamAccounts = [], selectedAccountId = null, lockedTeamAccountId = null, checkTimer = null;
        let currentUser = null, turnstileSiteKey = null, turnstileWidgetId = null;
        // 车位筛选: 'available'=有空位(绿), 'full'=已满(红), 'all'=全部(蓝)
        let teamFilter = 'available';

        const getToken = () => localStorage.getItem('token');
        const setToken = t => localStorage.setItem('token', t);
        const clearToken = () => localStorage.removeItem('token');

        async function init() {
            const params = new URLSearchParams(location.search);
            
            // 处理登录错误
            if (params.get('error') === 'trust_level') {
                const tl = params.get('tl') || '0';
                history.replaceState({}, '', '/');
                showTrustLevelError(tl);
                return;
            }
            
            // 处理从抽奖页面跳转过来的登录请求
            const lotteryReturn = params.get('lottery_return');
            if (lotteryReturn) {
                // 如果已经登录，直接带 token 跳回去
                const existingToken = getToken();
                if (existingToken) {
                    const separator = lotteryReturn.includes('?') ? '&' : '?';
                    window.location.href = lotteryReturn + separator + 'token=' + existingToken;
                    return;
                }
                // 未登录，保存回调地址，等登录后跳回
                localStorage.setItem('lottery_return', lotteryReturn);
                params.delete('lottery_return');
                history.replaceState({}, '', '/');
            }
            
            if (params.get('token')) {
                setToken(params.get('token'));
                history.replaceState({}, '', '/');
                
                // 如果有抽奖页面回调，带 token 跳回去
                const returnUrl = localStorage.getItem('lottery_return');
                if (returnUrl) {
                    localStorage.removeItem('lottery_return');
                    const token = getToken();
                    const separator = returnUrl.includes('?') ? '&' : '?';
                    window.location.href = returnUrl + separator + 'token=' + token;
                    return;
                }
            }
            try { turnstileSiteKey = (await (await fetch('/api/turnstile/site-key')).json()).siteKey; } catch {}
            
            // 检查维护模式
            const maintenanceOk = await checkMaintenanceMode();
            if (!maintenanceOk) return;
            
            getToken() ? await loadUserState() : showLoginPanel();
            loadTeamAccounts();
        }
        
        async function checkMaintenanceMode() {
            try {
                const res = await fetch('/api/maintenance/status', {
                    headers: getToken() ? { 'Authorization': 'Bearer ' + getToken() } : {}
                });
                if (!res.ok) return true;
                const data = await res.json();
                
                if (data.enabled && !data.userAllowed) {
                    showMaintenancePage(data.message, data.endTime);
                    return false;
                }
            } catch (e) {
                console.error('检查维护模式失败:', e);
            }
            return true;
        }
        
        function showMaintenancePage(message, endTime) {
            document.getElementById('loadingOverlay').classList.add('fade-out');
            document.getElementById('loginPanel').classList.add('hidden');
            
            // 设置维护信息
            document.getElementById('maintenanceMsg').textContent = message || '正在修车，请稍后再来';
            
            // 设置预计恢复时间
            const endTimeEl = document.getElementById('maintenanceEndTimeText');
            if (endTime) {
                const dt = new Date(endTime);
                if (!isNaN(dt.getTime())) {
                    endTimeEl.innerHTML = '预计恢复时间: <strong>' + dt.toLocaleString('zh-CN') + '</strong>';
                } else {
                    endTimeEl.textContent = '';
                }
            } else {
                endTimeEl.textContent = '';
            }
            
            // 显示维护页面
            document.getElementById('maintenancePage').classList.remove('hidden');
        }
        
        function showTrustLevelError(currentTL) {
            document.getElementById('loadingOverlay').classList.add('fade-out');
            document.getElementById('loginPanel').innerHTML = `
                <section class="card login-card">
                    <h2 style="color: var(--danger);">⚠️ 无法登录</h2>
                    <p style="margin-bottom: 1rem;">本站仅对 <strong>TL2 及以上</strong> 用户开放</p>
                    <p style="color: var(--muted); margin-bottom: 1.5rem;">您当前的信任级别为 <strong style="color: var(--danger);">TL${currentTL}</strong></p>
                    <p style="font-size: 0.85rem; color: var(--muted);">请在 LinuxDO 社区提升信任级别后再试</p>
                    <a href="https://linux.do" class="btn-linuxdo" style="margin-top: 1.5rem; background: var(--primary);">
                        前往 LinuxDO
                    </a>
                </section>
            `;
        }

        // ========== 班车表 ==========
        let scheduleTimer = null;
        let scheduleData = [];
        
        async function loadSchedule() {
            try {
                const res = await fetch('/api/scheduled-opens');
                const data = await res.json();
                scheduleData = data.schedules || [];
                renderSchedule();
            } catch (err) {
                console.error('加载班车表失败:', err);
            }
        }
        
        function renderSchedule() {
            const container = document.getElementById('scheduleContent');
            const now = new Date();
            
            // 过滤出未来的班次
            const futureSchedules = scheduleData.filter(s => new Date(s.scheduledTime) > now);
            
            if (futureSchedules.length === 0) {
                container.innerHTML = '<p class="schedule-empty">暂无班次</p>';
                return;
            }
            
            let html = '';
            for (const schedule of futureSchedules.slice(0, 5)) { // 最多显示5个
                const dt = new Date(schedule.scheduledTime);
                const diff = dt - now;
                
                const timeStr = dt.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
                const dateStr = dt.toLocaleDateString('zh-CN', { month: 'numeric', day: 'numeric' });
                
                const hours = Math.floor(diff / 3600000);
                const mins = Math.floor((diff % 3600000) / 60000);
                const secs = Math.floor((diff % 60000) / 1000);
                
                let countdown = '';
                if (hours > 0) {
                    countdown = `${hours}小时${mins}分钟`;
                } else if (mins > 0) {
                    countdown = `${mins}分${secs}秒`;
                } else {
                    countdown = `${secs}秒`;
                }
                
                html += `
                    <div class="schedule-item">
                        <div class="schedule-time">${dateStr} ${timeStr}</div>
                        <div class="schedule-countdown">⏱ ${countdown}后发车</div>
                    </div>
                `;
            }
            
            container.innerHTML = html;
        }
        
        function startScheduleTimer() {
            if (scheduleTimer) clearInterval(scheduleTimer);
            // 每秒更新倒计时显示
            scheduleTimer = setInterval(() => {
                renderSchedule();
            }, 1000);
            // 每30秒重新加载数据
            setInterval(() => {
                loadSchedule();
            }, 30000);
        }
        
        // 班车表拖拽功能
        function initScheduleDrag() {
            const sidebar = document.getElementById('scheduleSidebar');
            if (!sidebar) return;
            
            let isDragging = false;
            let offsetX = 0, offsetY = 0;
            
            sidebar.addEventListener('mousedown', (e) => {
                isDragging = true;
                offsetX = e.clientX - sidebar.offsetLeft;
                offsetY = e.clientY - sidebar.offsetTop;
                sidebar.classList.add('dragging');
            });
            
            document.addEventListener('mousemove', (e) => {
                if (!isDragging) return;
                e.preventDefault();
                let x = e.clientX - offsetX;
                let y = e.clientY - offsetY;
                // 限制在窗口内
                x = Math.max(0, Math.min(x, window.innerWidth - sidebar.offsetWidth));
                y = Math.max(0, Math.min(y, window.innerHeight - sidebar.offsetHeight));
                sidebar.style.left = x + 'px';
                sidebar.style.top = y + 'px';
                sidebar.style.right = 'auto';
            });
            
            document.addEventListener('mouseup', () => {
                isDragging = false;
                sidebar.classList.remove('dragging');
            });
        }
        
        // 初始化拖拽
        initScheduleDrag();

        // ========== 主题切换 ==========
        function toggleTheme() {
            const html = document.documentElement;
            const isDark = html.getAttribute('data-theme') === 'dark';
            html.setAttribute('data-theme', isDark ? '' : 'dark');
            localStorage.setItem('theme', isDark ? 'light' : 'dark');
            updateThemeIcon();
            // 重新渲染 Turnstile 以匹配主题
            if (turnstileSiteKey && window.turnstile && turnstileWidgetId !== null) {
                window.turnstile.remove(turnstileWidgetId);
                turnstileWidgetId = window.turnstile.render(document.getElementById('turnstileContainer'), { 
                    sitekey: turnstileSiteKey, 
                    theme: isDark ? 'light' : 'dark',  // 注意：isDark 是切换前的状态
                    size: 'flexible' 
                });
            }
        }
        
        function updateThemeIcon() {
            const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
            document.getElementById('themeIcon').innerHTML = isDark 
                ? '<circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>'
                : '<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>';
        }
        
        // 初始化主题
        (function() {
            const saved = localStorage.getItem('theme');
            if (saved === 'dark' || (!saved && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.setAttribute('data-theme', 'dark');
            }
            updateThemeIcon();
        })();

        async function loadUserState() {
            try {
                const res = await fetch('/api/user/state', { headers: { Authorization: 'Bearer ' + getToken() } });
                if (!res.ok) throw 0;
                currentUser = (await res.json()).user;
                showLoggedInUI();
                // 加载在线用户并启动心跳
                loadOnlineUsers();
                startHeartbeat();
            } catch { clearToken(); showLoginPanel(); }
        }

        // ========== 在线用户 ==========
        let heartbeatTimer = null;
        let onlineUsersTimer = null;

        async function loadOnlineUsers() {
            try {
                const res = await fetch('/api/online-users');
                if (!res.ok) return;
                const data = await res.json();
                renderOnlineUsers(data.count, data.users);
            } catch (e) {
                console.error('加载在线用户失败:', e);
            }
        }

        function renderOnlineUsers(count, users) {
            const sidebar = document.getElementById('onlineUsersSidebar');
            const countEl = document.getElementById('onlineCount');
            const listEl = document.getElementById('onlineUsersList');
            
            if (!sidebar) return;
            
            // 显示侧边栏
            sidebar.classList.remove('hidden');
            countEl.textContent = count;
            
            if (users.length === 0) {
                listEl.innerHTML = '<p class="schedule-empty">暂无在线用户</p>';
                return;
            }
            
            let html = '';
            for (const user of users) {
                let avatarUrl = '';
                if (user.avatar) {
                    avatarUrl = user.avatar.replace('{size}', '48');
                    if (!avatarUrl.startsWith('http')) {
                        avatarUrl = 'https://linux.do' + avatarUrl;
                    }
                }
                
                html += `
                    <div class="online-user-item">
                        <span class="online-dot"></span>
                        ${avatarUrl ? `<img src="${avatarUrl}" class="online-user-avatar" alt="">` : ''}
                        <span class="online-user-name">${escapeHtml(user.name || user.username)}</span>
                    </div>
                `;
            }
            listEl.innerHTML = html;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function startHeartbeat() {
            // 每30秒发送心跳
            if (heartbeatTimer) clearInterval(heartbeatTimer);
            heartbeatTimer = setInterval(async () => {
                if (!getToken()) return;
                try {
                    await fetch('/api/user/heartbeat', {
                        method: 'POST',
                        headers: { Authorization: 'Bearer ' + getToken() }
                    });
                } catch (e) {}
            }, 30000);
            
            // 每15秒刷新在线用户列表
            if (onlineUsersTimer) clearInterval(onlineUsersTimer);
            onlineUsersTimer = setInterval(loadOnlineUsers, 15000);
        }

        function showLoginPanel() {
            document.getElementById('loginPanel').classList.remove('hidden');
            document.getElementById('teamSection').classList.add('hidden');
            document.getElementById('inviteSection').classList.add('hidden');
            document.getElementById('userInfo').classList.add('hidden');
        }

        function showLoggedInUI() {
            document.getElementById('loginPanel').classList.add('hidden');
            document.getElementById('teamSection').classList.remove('hidden');
            const ui = document.getElementById('userInfo');
            
            // 构建头像URL
            let avatarUrl = '';
            if (currentUser.avatar_template) {
                avatarUrl = currentUser.avatar_template.replace('{size}', '120');
                if (!avatarUrl.startsWith('http')) {
                    avatarUrl = 'https://linux.do' + avatarUrl;
                }
            }
            
            const displayName = currentUser.name || currentUser.username;
            const trustLevel = currentUser.trust_level || 0;
            
            const fallbackAvatar = `data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><circle cx=%2250%22 cy=%2250%22 r=%2250%22 fill=%22%232563eb%22/><text x=%2250%22 y=%2265%22 font-size=%2250%22 fill=%22white%22 text-anchor=%22middle%22>${currentUser.username[0].toUpperCase()}</text></svg>`;
            
            ui.innerHTML = `
                <img src="${avatarUrl}" alt="avatar" class="user-avatar" onerror="this.src='${fallbackAvatar}'">
                <div class="user-card">
                    <div class="user-card-name">${displayName}</div>
                    <div class="user-card-username">@${currentUser.username}</div>
                    <div class="user-card-meta">ID: ${currentUser.user_id} · Trust ${trustLevel}</div>
                    <button class="user-card-logout" onclick="logout()"><i class="bi bi-box-arrow-right"></i> </button>
                </div>
            `;
            ui.classList.remove('hidden');
            
            // 如果用户已使用过邀请，隐藏邀请表单
            if (currentUser.hasUsed) {
                document.getElementById('inviteSection').classList.add('hidden');
            } else {
                document.getElementById('inviteSection').classList.remove('hidden');
                if (turnstileSiteKey && window.turnstile) {
                    const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
                    turnstileWidgetId = window.turnstile.render(document.getElementById('turnstileContainer'), { sitekey: turnstileSiteKey, theme: isDark ? 'dark' : 'light', size: 'flexible' });
                }
            }
            // 显示候车室入口并检测冷却状态
            document.getElementById('waitingEntry').classList.remove('hidden');
            checkCooldownStatus();
            // 初始化 hCaptcha
            if (window.hcaptcha && window.hcaptcha.render) {
                initHcaptcha();
            }
            // hCaptcha 脚本加载完成后会自动调用 onHcaptchaLoad
        }
        
        let countdownTimer = null;
        let isCountdownRefreshing = false;
        
        async function checkCooldownStatus() {
            const waitingNormal = document.getElementById('waitingNormal');
            const waitingClosed = document.getElementById('waitingClosed');
            const waitingCooldown = document.getElementById('waitingCooldown');
            const waitingEntry = document.getElementById('waitingEntry');
            const waitingCountdown = document.getElementById('waitingCountdown');
            
            // 先隐藏所有状态
            waitingNormal.classList.add('hidden');
            waitingClosed.classList.add('hidden');
            waitingCooldown.classList.add('hidden');
            
            // 清除之前的倒计时
            if (countdownTimer) {
                clearInterval(countdownTimer);
                countdownTimer = null;
            }
            
            try {
                // 先检查冷却状态（优先级最高）
                try {
                    const cooldownRes = await fetch('/api/user/cooldown', {
                        headers: { 'Authorization': 'Bearer ' + getToken() }
                    });
                    
                    if (cooldownRes.ok) {
                        const cooldownData = await cooldownRes.json();
                        if (cooldownData.inCooldown) {
                            // 在冷却期，直接显示冷却状态
                            waitingCooldown.classList.remove('hidden');
                            document.getElementById('cooldownDaysLeft').textContent = cooldownData.daysLeft || '?';
                            document.getElementById('cooldownEndDate').textContent = cooldownData.cooldownEnd || '未知';
                            waitingEntry.style.opacity = '0.6';
                            waitingEntry.style.pointerEvents = 'none';
                            return;
                        }
                    }
                } catch (e) {
                    console.error('检查冷却状态失败:', e);
                }
                
                // 检查候车室是否开放（带 token 检查用户是否在队列中）
                const settingsRes = await fetch('/api/admin/waiting-room-settings', {
                    headers: { 'Authorization': 'Bearer ' + getToken() }
                });
                
                // 无论 API 是否成功，都尝试解析响应
                let settings = null;
                try {
                    settings = await settingsRes.json();
                } catch (e) {
                    console.error('解析候车室设置失败:', e);
                }
                
                if (settings) {
                    if (!settings.enabled && !settings.userInQueue) {
                        // 候车室关闭且用户不在队列中
                        waitingClosed.classList.remove('hidden');
                        waitingEntry.style.opacity = '0.6';
                        waitingEntry.style.pointerEvents = 'none';
                        
                        // 如果有定时开放时间，显示倒计时
                        if (settings.scheduledTime) {
                            const openTime = new Date(settings.scheduledTime);
                            isCountdownRefreshing = false;
                            // 隐藏"候车室暂不开放"文字
                            document.getElementById('waitingClosedText').classList.add('hidden');
                            
                            // 显示开放位置数量
                            const maxQueueEl = document.getElementById('waitingMaxQueue');
                            if (settings.scheduledMaxQueue && settings.scheduledMaxQueue > 0) {
                                maxQueueEl.textContent = `本次开放 ${settings.scheduledMaxQueue} 个位置`;
                                maxQueueEl.classList.remove('hidden');
                            } else {
                                maxQueueEl.classList.add('hidden');
                            }
                            
                            let sseSource = null;
                            
                            function showOpened() {
                                isCountdownRefreshing = true;
                                if (countdownTimer) {
                                    clearInterval(countdownTimer);
                                    countdownTimer = null;
                                }
                                if (sseSource) {
                                    sseSource.close();
                                    sseSource = null;
                                }
                                waitingClosed.classList.add('hidden');
                                waitingNormal.classList.remove('hidden');
                                waitingEntry.style.opacity = '';
                                waitingEntry.style.pointerEvents = '';
                            }
                            
                            // 剩余15秒时启动 SSE 连接
                            function startSSE() {
                                if (sseSource) return;
                                sseSource = new EventSource('/api/waiting-room/events');
                                sseSource.onmessage = (e) => {
                                    try {
                                        const data = JSON.parse(e.data);
                                        if (data.event === 'opened') {
                                            showOpened();
                                        }
                                    } catch (err) {}
                                };
                                sseSource.onerror = () => {
                                    // 连接断开，3秒后重连
                                    if (sseSource) {
                                        sseSource.close();
                                        sseSource = null;
                                    }
                                    if (!isCountdownRefreshing) {
                                        setTimeout(startSSE, 3000);
                                    }
                                };
                            }
                            
                            function updateCountdown() {
                                if (isCountdownRefreshing) return;
                                
                                const now = new Date();
                                const diff = openTime - now;
                                
                                // 剩余15秒内启动 SSE
                                if (diff <= 15000 && diff > 0 && !sseSource) {
                                    startSSE();
                                }
                                
                                if (diff <= 0) {
                                    // 时间到，如果 SSE 没触发就直接切换
                                    showOpened();
                                    return;
                                }
                                
                                const hours = Math.floor(diff / 3600000);
                                const mins = Math.floor((diff % 3600000) / 60000);
                                const secs = Math.floor((diff % 60000) / 1000);
                                const totalMins = Math.floor(diff / 60000);
                                
                                // 根据时间远近变色: >10分钟绿色, 5-10分钟黄色, <5分钟红色
                                let color;
                                if (totalMins > 10) {
                                    color = 'var(--success)';  // 绿色
                                } else if (totalMins > 5) {
                                    color = '#f59e0b';  // 黄色
                                } else {
                                    color = 'var(--danger)';  // 红色
                                }
                                waitingCountdown.style.color = color;
                                
                                if (hours > 0) {
                                    waitingCountdown.textContent = `⏱ ${hours}小时${mins}分钟 后开放`;
                                } else if (mins > 0) {
                                    waitingCountdown.textContent = `⏱ ${mins}分${secs}秒 后开放`;
                                } else {
                                    waitingCountdown.textContent = `⏱ ${secs}秒 后开放`;
                                }
                            }
                            
                            updateCountdown();
                            countdownTimer = setInterval(updateCountdown, 1000);
                        } else {
                            // 没有定时，显示"候车室暂不开放"
                            document.getElementById('waitingClosedText').classList.remove('hidden');
                            waitingCountdown.textContent = '请关注后续通知';
                            waitingCountdown.style.color = 'var(--muted)';
                        }
                        return;
                    }
                    // 用户在队列中或候车室开放，允许访问
                }
                
                // 候车室开放或用户在队列中，恢复样式并显示正常入口
                waitingEntry.style.opacity = '';
                waitingEntry.style.pointerEvents = '';
                waitingNormal.classList.remove('hidden');
            } catch (err) {
                console.error('检测状态失败:', err);
                waitingNormal.classList.remove('hidden');
            }
        }

        document.getElementById('loginBtn').onclick = async e => {
            e.preventDefault();
            try { location.href = (await (await fetch('/api/oauth/login')).json()).authUrl; } catch { alert('登录失败'); }
        };

        function logout() { clearToken(); currentUser = null; showLoginPanel(); }

        // ========== hCaptcha ==========
        let hcaptchaSiteKey = null;
        let hcaptchaWidgetId = null;
        
        async function initHcaptcha() {
            try {
                const res = await fetch('/api/hcaptcha/site-key');
                const data = await res.json();
                hcaptchaSiteKey = data.siteKey;
                
                // 渲染隐藏的 hCaptcha widget
                if (hcaptchaSiteKey && window.hcaptcha) {
                    hcaptchaWidgetId = hcaptcha.render('hcaptchaWidget', {
                        sitekey: hcaptchaSiteKey,
                        size: 'invisible',
                        callback: onHcaptchaSuccess,
                        'expired-callback': onHcaptchaExpired,
                        'close-callback': resetWaitingButton,
                        'chalexpired-callback': resetWaitingButton,
                        'error-callback': resetWaitingButton,
                        theme: document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'light'
                    });
                }
            } catch (e) {
                console.error('hCaptcha 初始化失败:', e);
            }
        }
        
        function onHcaptchaLoad() {
            initHcaptcha();
        }
        
        async function onHcaptchaSuccess(token) {
            // hCaptcha 验证成功，调用后端验证并跳转
            await verifyAndEnterWaiting();
        }
        
        function onHcaptchaExpired() {
            // 验证过期，重置按钮状态
            resetWaitingButton();
            if (hcaptchaWidgetId !== null && window.hcaptcha) {
                hcaptcha.reset(hcaptchaWidgetId);
            }
        }
        
        function setWaitingButtonLoading() {
            const btn = document.getElementById('enterWaitingBtn');
            const icon = document.getElementById('enterWaitingIcon');
            const spinner = document.getElementById('enterWaitingSpinner');
            const text = document.getElementById('enterWaitingText');
            if (btn) btn.disabled = true;
            if (icon) icon.classList.add('hidden');
            if (spinner) spinner.classList.remove('hidden');
            if (text) text.textContent = '加载中...';
        }
        
        function resetWaitingButton() {
            const btn = document.getElementById('enterWaitingBtn');
            const icon = document.getElementById('enterWaitingIcon');
            const spinner = document.getElementById('enterWaitingSpinner');
            const text = document.getElementById('enterWaitingText');
            if (btn) btn.disabled = false;
            if (icon) icon.classList.remove('hidden');
            if (spinner) spinner.classList.add('hidden');
            if (text) text.textContent = '进入候车室';
        }
        
        async function enterWaitingRoom() {
            // 未配置 hCaptcha，直接验证并跳转
            if (!hcaptchaSiteKey) {
                await verifyAndEnterWaiting();
                return;
            }
            
            // 显示加载状态
            setWaitingButtonLoading();
            
            // 触发 hCaptcha 验证
            if (window.hcaptcha && hcaptchaWidgetId !== null) {
                hcaptcha.execute(hcaptchaWidgetId);
            } else {
                await verifyAndEnterWaiting();
            }
        }
        
        async function verifyAndEnterWaiting() {
            try {
                const res = await fetch('/api/waiting/verify', {
                    method: 'POST',
                    headers: { 'Authorization': 'Bearer ' + getToken() }
                });
                if (res.ok) {
                    location.href = '/waiting';
                } else {
                    const data = await res.json();
                    alert(data.error || '验证失败');
                    resetWaitingButton();
                }
            } catch (e) {
                alert('网络错误');
                resetWaitingButton();
            }
        }

        async function loadTeamAccounts() {
            try {
                teamAccounts = (await (await fetch('/api/team-accounts/status')).json()).accounts || [];
                renderTeamAccounts();
                updateTeamSelect();
            } catch { document.getElementById('teamAccountsContainer').innerHTML = '<p class="muted" style="text-align:center">加载失败</p>'; }
        }

        // 切换车位筛选
        function toggleTeamFilter() {
            const icon = document.getElementById('teamFilterIcon');
            const label = document.getElementById('teamFilterLabel');
            // 循环切换: available -> full -> all -> available
            if (teamFilter === 'available') {
                teamFilter = 'full';
                icon.style.fill = 'var(--danger)';
                label.style.color = 'var(--danger)';
                label.textContent = '已满车位';
            } else if (teamFilter === 'full') {
                teamFilter = 'all';
                icon.style.fill = 'var(--primary)';
                label.style.color = 'var(--primary)';
                label.textContent = '全部车位';
            } else {
                teamFilter = 'available';
                icon.style.fill = 'var(--success)';
                label.style.color = 'var(--success)';
                label.textContent = '可用车位';
            }
            renderTeamAccounts();
        }
        
        function renderTeamAccounts() {
            const c = document.getElementById('teamAccountsContainer');
            if (!teamAccounts.length) { c.innerHTML = '<p class="muted" style="text-align:center">暂无车位</p>'; return; }
            
            // 根据筛选条件过滤
            let filtered = teamAccounts.filter(a => {
                const avail = Math.max(0, a.seatsEntitled - a.seatsInUse - a.pendingInvites);
                if (teamFilter === 'available') return avail > 0;
                if (teamFilter === 'full') return avail === 0;
                return true; // all
            });
            
            if (!filtered.length) {
                const msg = teamFilter === 'available' ? '暂无可用车位' : teamFilter === 'full' ? '暂无已满车位' : '暂无车位';
                c.innerHTML = `<p class="muted" style="text-align:center">${msg}</p>`;
                return;
            }
            
            c.innerHTML = filtered.map(a => {
                const avail = Math.max(0, a.seatsEntitled - a.seatsInUse - a.pendingInvites);
                const full = a.seatsInUse + a.pendingInvites >= 5;
                const sel = selectedAccountId === a.id;
                const exp = a.activeUntil ? new Date(a.activeUntil).toLocaleDateString() : '';
                return `<div class="team-row ${sel?'selected':''} ${full?'full':''}" onclick="selectAccount(${a.id},${full})">
                    <span class="team-name">${a.name}</span>
                    <div class="team-info">
                        <span class="team-stat">${a.seatsInUse}/${a.seatsEntitled} 已用</span>
                        ${a.pendingInvites?`<span class="team-stat">${a.pendingInvites} 待处理</span>`:''}
                        <span class="team-stat ${full?'full':'available'}">${avail} 剩余</span>
                        ${exp?`<span class="team-stat">到期 ${exp}</span>`:''}
                    </div>
                </div>`;
            }).join('');
        }

        function selectAccount(id, full) {
            if (full || lockedTeamAccountId) return;
            selectedAccountId = id;
            renderTeamAccounts();
            document.getElementById('teamSelect').value = id;
        }

        function updateTeamSelect() {
            const s = document.getElementById('teamSelect');
            s.innerHTML = '<option value="">请选择车位</option>' + teamAccounts.map(a => {
                const full = a.seatsInUse + a.pendingInvites >= 5;
                return `<option value="${a.id}" ${full?'disabled':''}>${a.name} (${a.seatsInUse+a.pendingInvites}/${a.seatsEntitled})${full?' (不可选)':''}</option>`;
            }).join('');
            if (selectedAccountId) s.value = selectedAccountId;
            else { const av = teamAccounts.find(a => a.seatsInUse + a.pendingInvites < 5); if (av) { selectedAccountId = av.id; s.value = av.id; } }
        }

        async function checkInviteCode(code) {
            if (!code) { lockedTeamAccountId = null; document.getElementById('lockedHint').classList.add('hidden'); document.getElementById('teamSelect').disabled = false; return; }
            try {
                const res = await fetch('/api/invite/check', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ code }) });
                const d = await res.json();
                if (res.ok && d.teamAccountId) {
                    lockedTeamAccountId = selectedAccountId = d.teamAccountId;
                    document.getElementById('teamSelect').value = d.teamAccountId;
                    document.getElementById('teamSelect').disabled = true;
                    document.getElementById('lockedHint').classList.remove('hidden');
                    renderTeamAccounts();
                } else { lockedTeamAccountId = null; document.getElementById('teamSelect').disabled = false; document.getElementById('lockedHint').classList.add('hidden'); }
            } catch {}
        }

        const form = document.getElementById('inviteForm'), codeInput = document.getElementById('code');
        const message = document.getElementById('message'), submitBtn = document.getElementById('submitBtn');

        codeInput.oninput = () => { clearTimeout(checkTimer); checkTimer = setTimeout(() => checkInviteCode(codeInput.value.trim()), 300); };
        document.getElementById('teamSelect').onchange = e => { if (!lockedTeamAccountId) { selectedAccountId = +e.target.value || null; renderTeamAccounts(); } };

        function showMessage(t, err) { message.textContent = t; message.className = 'message ' + (err ? 'error' : 'success'); message.classList.remove('hidden'); }

        form.onsubmit = async e => {
            e.preventDefault();
            if (!getToken()) { showMessage('请先登录', 1); return; }
            const code = codeInput.value.trim(), email = document.getElementById('email').value.trim();
            const teamAccountId = lockedTeamAccountId || selectedAccountId;
            if (!teamAccountId) { showMessage('请选择车位', 1); return; }
            let tt = '';
            if (turnstileSiteKey && window.turnstile && turnstileWidgetId !== null) {
                tt = window.turnstile.getResponse(turnstileWidgetId);
                if (!tt) { showMessage('请完成人机验证', 1); return; }
            }
            submitBtn.disabled = true; submitBtn.textContent = '发送中...'; message.classList.add('hidden');
            try {
                const res = await fetch('/api/invite/use', { method: 'POST', headers: { 'Content-Type': 'application/json', Authorization: 'Bearer ' + getToken() }, body: JSON.stringify({ code, email, teamAccountId, turnstileToken: tt }) });
                const d = await res.json();
                if (res.ok) {
                    document.getElementById('formSection').classList.add('hidden');
                    document.getElementById('successSection').classList.remove('hidden');
                    document.getElementById('successEmail').textContent = email;
                    loadTeamAccounts();
                } else { showMessage(d.error || '提交失败', 1); window.turnstile?.reset?.(turnstileWidgetId); }
            } catch { showMessage('网络错误', 1); window.turnstile?.reset?.(turnstileWidgetId); }
            finally { submitBtn.disabled = false; submitBtn.textContent = '发送邀请'; }
        };

        function hideLoading() { const o = document.getElementById('loadingOverlay'); o.classList.add('fade-out'); setTimeout(() => o.remove(), 300); }
        
        // 上海时间时钟
        function updateShanghaiClock() {
            const now = new Date();
            const shanghaiTime = new Date(now.toLocaleString('en-US', { timeZone: 'Asia/Shanghai' }));
            const timeStr = shanghaiTime.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false });
            document.getElementById('shanghaiClock').innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16" style="vertical-align: -2px; margin-right: 4px;"><path d="M8 3.5a.5.5 0 0 0-1 0V9a.5.5 0 0 0 .252.434l3.5 2a.5.5 0 0 0 .496-.868L8 8.71V3.5z"/><path d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16zm7-8A7 7 0 1 1 1 8a7 7 0 0 1 14 0z"/></svg>' + timeStr;
        }
        updateShanghaiClock();
        setInterval(updateShanghaiClock, 1000);
        
        init().then(hideLoading).catch(hideLoading);
        setInterval(loadTeamAccounts, 60000);
        
        // 加载班车表
        loadSchedule();
        startScheduleTimer();
    </script>
    <!-- Live2D 看板娘 -->
    <script src="/live2d-init.js"></script>
</body>
</html>
