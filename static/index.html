<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é‚€è¯·ç é¢†å–</title>
    <!-- å¼•å…¥ Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>
    <style>
        :root {
            --primary: #2563eb;
            --primary-hover: #1d4ed8;
            --bg: #f8f9fa;
        }
        
        body { 
            background-color: var(--bg); 
            font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }

        /* åŠ¨ç”»ä¸ç‰¹æ®ŠSVGæ ·å¼ä¿ç•™ (Bootstrapæœ¬èº«æ²¡æœ‰è¿™äº›) */
        
        /* ä»ªè¡¨ç›˜ SVG æ ·å¼ */
        .gauge {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 50px;
        }
        .gauge svg {
            width: 48px;
            height: 48px;
            transform: rotate(-90deg);
        }
        .gauge-bg {
            fill: none;
            stroke: #e9ecef; /* Bootstrap gray-200 */
            stroke-width: 3;
        }
        .gauge-fill {
            fill: none;
            stroke-width: 3;
            stroke-linecap: round;
            transition: stroke-dasharray 0.3s;
        }
        .gauge-fill.used { stroke: #ffc107; } /* Bootstrap warning */
        .gauge-fill.pending { stroke: #6f42c1; } /* Bootstrap purple */
        .gauge-fill.total { stroke: #0d6efd; } /* Bootstrap primary */
        .gauge-fill.available { stroke: #198754; } /* Bootstrap success */
        .gauge-fill.empty { stroke: #dc3545; } /* Bootstrap danger */
        .gauge-text {
            fill: var(--bs-body-color);
            font-size: 10px;
            font-weight: 700;
            text-anchor: middle;
            transform: rotate(90deg);
            transform-origin: center;
        }
        .gauge-label {
            font-size: 0.7rem;
            color: var(--bs-secondary-color);
            margin-top: 2px;
            white-space: nowrap;
        }

        /* é€‰ä¸­çŠ¶æ€çš„è¾¹æ¡†æ ·å¼ */
        .dashboard-row {
            transition: all 0.2s;
            border: 2px solid transparent; /* é¢„ç•™è¾¹æ¡†ä½ç½®é¿å…æŠ–åŠ¨ */
        }
        .dashboard-row:hover:not(.full) {
            transform: translateY(-2px);
            box-shadow: 0 .5rem 1rem rgba(0,0,0,.15)!important;
        }
        .dashboard-row.selected {
            border-color: var(--primary);
            background-color: #f0f7ff;
        }
        .dashboard-row.full {
            opacity: 0.6;
            cursor: not-allowed;
            background-color: #e9ecef;
        }

        /* LinuxDO æŒ‰é’®è‡ªå®šä¹‰é¢œè‰² */
        .btn-linuxdo {
            background: #f97316;
            color: #fff;
            border: none;
        }
        .btn-linuxdo:hover {
            background: #ea580c;
            color: #fff;
        }

        /* åŠ è½½åŠ¨ç”»å…¨å±å±‚ */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.3s ease;
        }
        .loading-overlay.fade-out {
            opacity: 0;
            pointer-events: none;
        }

        /* å¤æ‚SVGåŠ¨ç”»ä¿ç•™åŸæ · */
        .logo-container { width: 80px; height: 80px; }
        .tech-stroke {
            fill: none;
            stroke: var(--primary);
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
            filter: drop-shadow(0 0 2px var(--primary));
        }
        .ring-group { transform-origin: 50px 50px; animation: continuousSpin 3s linear infinite; }
        .draw-path { stroke-dasharray: 100; stroke-dashoffset: 100; animation: drawLine 1s ease-out forwards; }
        .center-circle {
            animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards 0.6s;
            opacity: 0; transform-origin: 50px 50px; fill: var(--bg); stroke: var(--primary);
        }
        @keyframes drawLine { to { stroke-dashoffset: 0; } }
        @keyframes continuousSpin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes popIn { 0% { opacity: 0; transform: scale(0); } 100% { opacity: 1; transform: scale(1); } }

        /* å·¥å…·ç±» */
        .hidden { display: none !important; }
        .user-avatar { width: 32px; height: 32px; object-fit: cover; }
    </style>
</head>
<body>
    <!-- åŠ è½½åŠ¨ç”» -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="logo-container">
            <svg viewBox="0 0 100 100">
                <defs>
                    <path id="tech-petal" d="M40,22 L60,22 L62,24 L60,26 L40,26 L38,24 Z" />
                </defs>
                <g class="ring-group">
                    <use href="#tech-petal" class="tech-stroke draw-path" transform="rotate(0, 50, 50)" style="animation-delay: 0s" />
                    <use href="#tech-petal" class="tech-stroke draw-path" transform="rotate(60, 50, 50)" style="animation-delay: 0.08s" />
                    <use href="#tech-petal" class="tech-stroke draw-path" transform="rotate(120, 50, 50)" style="animation-delay: 0.16s" />
                    <use href="#tech-petal" class="tech-stroke draw-path" transform="rotate(180, 50, 50)" style="animation-delay: 0.24s" />
                    <use href="#tech-petal" class="tech-stroke draw-path" transform="rotate(240, 50, 50)" style="animation-delay: 0.32s" />
                    <use href="#tech-petal" class="tech-stroke draw-path" transform="rotate(300, 50, 50)" style="animation-delay: 0.4s" />
                </g>
                <circle class="center-circle tech-stroke" cx="50" cy="50" r="8" stroke-width="2" />
            </svg>
        </div>
    </div>

    <!-- å¯¼èˆªæ  -->
    <nav class="navbar navbar-expand navbar-light bg-white border-bottom shadow-sm fixed-top">
        <div class="container">
            <a href="/" class="navbar-brand fw-bold text-primary">
                <span class="fs-4 me-2">ğŸ«</span>Team Invite
            </a>
            <div id="userInfo" class="d-flex align-items-center gap-3 hidden">
                <!-- ç”¨æˆ·ä¿¡æ¯ç”±JSæ³¨å…¥ -->
            </div>
        </div>
    </nav>

    <!-- å ä½ç¬¦é˜²æ­¢å†…å®¹è¢«å›ºå®šå¯¼èˆªæ é®æŒ¡ -->
    <div style="height: 70px;"></div>

    <main class="container py-4">
        
        <!-- ç™»å½•å¡ç‰‡ (å…¨å±å±…ä¸­è¦†ç›–) -->
        <div id="loginPanel" class="position-fixed top-0 start-0 w-100 h-100 d-flex justify-content-center align-items-center bg-light" style="z-index: 1050;">
            <div class="card border-0 shadow-lg rounded-4" style="max-width: 400px; width: 90%;">
                <div class="card-body p-4 p-md-5 text-center">
                    <h2 class="h3 fw-bold mb-2">æ¬¢è¿ç™»å½•</h2>
                    <p class="text-secondary mb-4">è¯·ç™»å½•ä»¥ç»§ç»­é¢†å–é‚€è¯·ç </p>
                    <button class="btn btn-linuxdo btn-lg w-100 d-flex align-items-center justify-content-center gap-2 py-3 rounded-3" id="loginBtn">
                        <svg width="24" height="24" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="m7.44,0s.09,0,.13,0c.09,0,.19,0,.28,0,.14,0,.29,0,.43,0,.09,0,.18,0,.27,0q.12,0,.25,0t.26.08c.15.03.29.06.44.08,1.97.38,3.78,1.47,4.95,3.11.04.06.09.12.13.18.67.96,1.15,2.11,1.3,3.28q0,.19.09.26c0,.15,0,.29,0,.44,0,.04,0,.09,0,.13,0,.09,0,.19,0,.28,0,.14,0,.29,0,.43,0,.09,0,.18,0,.27,0,.08,0,.17,0,.25q0,.19-.08.26c-.03.15-.06.29-.08.44-.38,1.97-1.47,3.78-3.11,4.95-.06.04-.12.09-.18.13-.96.67-2.11,1.15-3.28,1.3q-.19,0-.26.09c-.15,0-.29,0-.44,0-.04,0-.09,0-.13,0-.09,0-.19,0-.28,0-.14,0-.29,0-.43,0-.09,0-.18,0-.27,0-.08,0-.17,0-.25,0q-.19,0-.26-.08c-.15-.03-.29-.06-.44-.08-1.97-.38-3.78-1.47-4.95-3.11q-.07-.09-.13-.18c-.67-.96-1.15-2.11-1.3-3.28q0-.19-.09-.26c0-.15,0-.29,0-.44,0-.04,0-.09,0-.13,0-.09,0-.19,0-.28,0-.14,0-.29,0-.43,0-.09,0-.18,0-.27,0-.08,0-.17,0-.25q0-.19.08-.26c.03-.15.06-.29.08-.44.38-1.97,1.47-3.78,3.11-4.95.06-.04.12-.09.18-.13C4.42.73,5.57.26,6.74.1,7,.07,7.15,0,7.44,0Z" fill="#EFEFEF"/>
                            <path d="m1.27,11.33h13.45c-.94,1.89-2.51,3.21-4.51,3.88-1.99.59-3.96.37-5.8-.57-1.25-.7-2.67-1.9-3.14-3.3Z" fill="#FEB005"/>
                            <path d="m12.54,1.99c.87.7,1.82,1.59,2.18,2.68H1.27c.87-1.74,2.33-3.13,4.2-3.78,2.44-.79,5-.47,7.07,1.1Z" fill="#1D1D1F"/>
                        </svg>
                        <span>ä½¿ç”¨ LinuxDO ç™»å½•</span>
                    </button>
                </div>
            </div>
        </div>

        <div class="row g-4 justify-content-center">
            
            <!-- è½¦ä½çŠ¶æ€ -->
            <div class="col-lg-8" id="teamDashboardCol">
                <section id="teamSection" class="card border-0 shadow-sm rounded-4 h-100 hidden">
                    <div class="card-header bg-white border-bottom-0 pt-4 px-4 pb-0">
                        <h2 class="h5 fw-bold mb-0 text-primary">ğŸš— è½¦ä½çŠ¶æ€</h2>
                        <p class="text-muted small mt-1">è¯·é€‰æ‹©ä¸€ä¸ªå‰©ä½™ç©ºä½çš„è½¦é˜Ÿ (ç‚¹å‡»å¡ç‰‡é€‰æ‹©)</p>
                    </div>
                    <div class="card-body px-4 pb-4">
                        <div id="teamAccountsContainer" class="d-flex flex-column gap-3">
                            <div class="text-center py-5 text-muted">
                                <div class="spinner-border text-primary mb-2" role="status"></div>
                                <p>æ•°æ®åŠ è½½ä¸­...</p>
                            </div>
                        </div>
                    </div>
                </section>
            </div>

            <!-- é‚€è¯·ç è¡¨å• -->
            <div class="col-lg-4">
                <section id="inviteSection" class="card border-0 shadow-sm rounded-4 hidden sticky-lg-top" style="top: 90px; z-index: 1020;">
                    <div class="card-body p-4">
                        <h1 class="h4 text-center fw-bold mb-2">å¡«å†™é‚€è¯·ä¿¡æ¯</h1>
                        <p class="text-center text-secondary mb-4 small">è¾“å…¥é‚€è¯·ç å’Œé‚®ç®±å®Œæˆé¢†å–</p>
                        
                        <div id="formSection">
                            <form id="inviteForm">
                                <div class="mb-3">
                                    <label for="code" class="form-label fw-bold small text-secondary">é‚€è¯·ç </label>
                                    <input type="text" class="form-control form-control-lg bg-light" id="code" placeholder="è¯·è¾“å…¥é‚€è¯·ç " required autocomplete="off">
                                </div>
                                <div class="mb-3">
                                    <label for="email" class="form-label fw-bold small text-secondary">é‚®ç®±åœ°å€</label>
                                    <input type="email" class="form-control form-control-lg bg-light" id="email" placeholder="you@example.com" required>
                                </div>
                                <div class="mb-3" id="teamSelectGroup">
                                    <label class="form-label fw-bold small text-secondary">é€‰æ‹©è½¦ä½</label>
                                    <select id="teamSelect" class="form-select form-select-lg bg-light" required>
                                        <option value="">è¯·é€‰æ‹©è½¦ä½</option>
                                    </select>
                                    <div id="lockedHint" class="form-text text-primary hidden">
                                        <i class="bi bi-lock-fill"></i> è¯¥é‚€è¯·ç å·²ç»‘å®šæŒ‡å®šè½¦ä½
                                    </div>
                                </div>
                                <div id="turnstileContainer" class="d-flex justify-content-center mb-4"></div>
                                <button type="submit" class="btn btn-primary btn-lg w-100 rounded-3" id="submitBtn">
                                   å‘é€é‚€è¯·
                                </button>
                            </form>
                            <div id="message" class="alert mt-3 text-center hidden" role="alert"></div>
                        </div>

                        <div id="successSection" class="hidden text-center py-3">
                            <div class="bg-success-subtle border border-success-subtle rounded-3 p-4">
                                <div class="display-1 text-success mb-3">âœ…</div>
                                <h2 class="h5 text-success fw-bold">å‘é€æˆåŠŸ</h2>
                                <p class="text-muted mb-1">é‚€è¯·å·²å‘é€åˆ°</p>
                                <p class="fw-bold fs-5 text-dark" id="successEmail"></p>
                            </div>
                            <button onclick="window.location.reload()" class="btn btn-outline-secondary mt-3 btn-sm">è¿”å›</button>
                        </div>
                    </div>
                </section>
            </div>
        </div>
    </main>

    <script>
        let teamAccounts = [];
        let selectedAccountId = null;
        let lockedTeamAccountId = null;
        let checkTimer = null;
        let currentUser = null;
        let turnstileSiteKey = null;
        let turnstileWidgetId = null;

        // è·å– token
        function getToken() {
            return localStorage.getItem('token');
        }
        function setToken(token) {
            localStorage.setItem('token', token);
        }
        function clearToken() {
            localStorage.removeItem('token');
        }

        // åˆå§‹åŒ–
        async function init() {
            const params = new URLSearchParams(window.location.search);
            const urlToken = params.get('token');
            if (urlToken) {
                setToken(urlToken);
                window.history.replaceState({}, '', '/');
            }

            try {
                const res = await fetch('/api/turnstile/site-key');
                const data = await res.json();
                turnstileSiteKey = data.siteKey;
            } catch (e) {}

            const token = getToken();
            if (token) {
                await loadUserState();
            } else {
                showLoginPanel();
            }

            loadTeamAccounts();
        }

        async function loadUserState() {
            const token = getToken();
            if (!token) {
                showLoginPanel();
                return;
            }
            try {
                const res = await fetch('/api/user/state', {
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                if (!res.ok) {
                    clearToken();
                    showLoginPanel();
                    return;
                }
                const data = await res.json();
                currentUser = data.user;
                showLoggedInUI();
            } catch (e) {
                clearToken();
                showLoginPanel();
            }
        }

        function showLoginPanel() {
            document.getElementById('loginPanel').classList.remove('hidden');
            document.getElementById('teamSection').classList.add('hidden');
            document.getElementById('inviteSection').classList.add('hidden');
            document.getElementById('userInfo').classList.add('hidden');
        }

        function showLoggedInUI() {
            document.getElementById('loginPanel').classList.add('hidden');
            document.getElementById('teamSection').classList.remove('hidden');
            document.getElementById('inviteSection').classList.remove('hidden');
            
            const userInfo = document.getElementById('userInfo');
            // ä½¿ç”¨ Bootstrap æ ·å¼
            userInfo.innerHTML = `
                <div class="d-flex align-items-center text-secondary">
                    <span class="fw-bold me-2 text-dark">${currentUser.username}</span>
                    <small class="border-start ps-3 ms-1"><a href="#" onclick="logout(); return false;" class="text-decoration-none text-muted">é€€å‡º</a></small>
                </div>
            `;
            userInfo.classList.remove('hidden');

            renderTurnstile();
        }

        function renderTurnstile() {
            if (!turnstileSiteKey) return;
            const container = document.getElementById('turnstileContainer');
            container.innerHTML = '';
            if (window.turnstile) {
                turnstileWidgetId = window.turnstile.render(container, {
                    sitekey: turnstileSiteKey,
                    callback: function(token) {}
                });
            }
        }

        document.getElementById('loginBtn').addEventListener('click', async (e) => {
            e.preventDefault();
            try {
                const res = await fetch('/api/oauth/login');
                const data = await res.json();
                if (data.authUrl) {
                    window.location.href = data.authUrl;
                }
            } catch (e) {
                alert('ç™»å½•å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        });

        function logout() {
            clearToken();
            currentUser = null;
            showLoginPanel();
        }

        async function loadTeamAccounts() {
            try {
                const res = await fetch('/api/team-accounts/status');
                const data = await res.json();
                teamAccounts = data.accounts || [];
                renderTeamAccounts();
                updateTeamSelect();
            } catch (e) {
                document.getElementById('teamAccountsContainer').innerHTML = '<div class="alert alert-danger text-center m-3">æ•°æ®åŠ è½½å¤±è´¥</div>';
            }
        }

        // ä¿®æ”¹ï¼šä½¿ç”¨ Bootstrap ç±»åç”Ÿæˆä»ªè¡¨ç›˜
        function renderTeamAccounts() {
            const container = document.getElementById('teamAccountsContainer');
            if (teamAccounts.length === 0) {
                container.innerHTML = '<div class="alert alert-info text-center m-3">æš‚æ— å¯ç”¨è½¦ä½</div>';
                return;
            }

            container.innerHTML = teamAccounts.map(acc => {
                const available = acc.seatsEntitled - acc.seatsInUse - acc.pendingInvites;
                const isFull = acc.seatsInUse + acc.pendingInvites >= 5;
                const isSelected = selectedAccountId === acc.id;
                const usedPct = acc.seatsEntitled > 0 ? (acc.seatsInUse / acc.seatsEntitled) * 100 : 0;
                const pendingPct = acc.seatsEntitled > 0 ? (acc.pendingInvites / acc.seatsEntitled) * 100 : 0;
                const availPct = acc.seatsEntitled > 0 ? (available / acc.seatsEntitled) * 100 : 0;
                
                let expireHtml = '';
                if (acc.activeUntil) {
                    const expireDate = new Date(acc.activeUntil).toLocaleDateString();
                    expireHtml = `
                        <div class="border-start ps-3 ms-2 d-none d-sm-block">
                            <div class="text-muted" style="font-size: 0.7rem;">åˆ°æœŸæ—¶é—´</div>
                            <div class="fw-bold small">${expireDate}</div>
                        </div>`;
                }

                // ä½¿ç”¨ card é£æ ¼, æ·»åŠ  p-3, rounded, shadow-sm, bg-white, cursor-pointer
                return `
                <div class="dashboard-row card border shadow-sm mb-0 ${isSelected ? 'selected' : ''} ${isFull ? 'full' : ''}" 
                     style="cursor: ${isFull ? 'not-allowed' : 'pointer'}"
                     onclick="selectAccount(${acc.id}, ${isFull})">
                    <div class="card-body p-3 d-flex flex-wrap align-items-center justify-content-between gap-3">
                        <div class="fw-bold fs-5 text-dark" style="min-width: 120px;">${acc.name}</div>
                        
                        <div class="d-flex align-items-center gap-3 flex-wrap justify-content-end flex-grow-1">
                            ${renderGauge(acc.seatsInUse, usedPct, 'used', 'å·²ç”¨')}
                            ${renderGauge(acc.pendingInvites, pendingPct, 'pending', 'å¾…å¤„ç†')}
                            ${renderGauge(acc.seatsEntitled, 100, 'total', 'æ€»å¸­ä½')}
                            ${renderGauge(available, availPct, isFull ? 'empty' : 'available', 'å‰©ä½™')}
                            ${expireHtml}
                        </div>
                    </div>
                </div>`;
            }).join('');
        }

        function renderGauge(value, pct, type, label) {
            return `
            <div class="gauge">
                <svg viewBox="0 0 36 36">
                    <path class="gauge-bg" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"/>
                    <path class="gauge-fill ${type}" stroke-dasharray="${pct}, 100" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"/>
                    <text x="18" y="20.5" class="gauge-text">${value}</text>
                </svg>
                <span class="gauge-label">${label}</span>
            </div>`;
        }

        function selectAccount(id, isFull) {
            if (isFull || lockedTeamAccountId) return;
            selectedAccountId = id;
            renderTeamAccounts();
            document.getElementById('teamSelect').value = id;
        }

        function updateTeamSelect() {
            const select = document.getElementById('teamSelect');
            select.innerHTML = '<option value="">è¯·é€‰æ‹©è½¦ä½</option>' + 
                teamAccounts.map(acc => {
                    const busy = acc.seatsInUse + acc.pendingInvites >= 5;
                    return `<option value="${acc.id}" ${busy ? 'disabled' : ''}>
                        ${acc.name} (${acc.seatsInUse + acc.pendingInvites}/${acc.seatsEntitled}) ${busy ? '(ä¸å¯é€‰)' : ''}
                    </option>`;
                }).join('');
            
            if (selectedAccountId) {
                select.value = selectedAccountId;
            } else if (teamAccounts.length > 0) {
                const available = teamAccounts.find(a => a.seatsInUse + a.pendingInvites < 5);
                if (available) {
                    selectedAccountId = available.id;
                    select.value = available.id;
                }
            }
        }

        async function checkInviteCode(code) {
            if (!code) {
                lockedTeamAccountId = null;
                document.getElementById('lockedHint').classList.add('hidden');
                document.getElementById('teamSelect').disabled = false;
                return;
            }
            try {
                const res = await fetch('/api/invite/check', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ code })
                });
                const data = await res.json();
                if (res.ok && data.teamAccountId) {
                    lockedTeamAccountId = data.teamAccountId;
                    selectedAccountId = data.teamAccountId;
                    document.getElementById('teamSelect').value = data.teamAccountId;
                    document.getElementById('teamSelect').disabled = true;
                    document.getElementById('lockedHint').classList.remove('hidden');
                    renderTeamAccounts();
                } else {
                    lockedTeamAccountId = null;
                    document.getElementById('teamSelect').disabled = false;
                    document.getElementById('lockedHint').classList.add('hidden');
                }
            } catch (e) {}
        }

        const form = document.getElementById('inviteForm');
        const codeInput = document.getElementById('code');
        const message = document.getElementById('message');
        const submitBtn = document.getElementById('submitBtn');

        codeInput.addEventListener('input', () => {
            clearTimeout(checkTimer);
            checkTimer = setTimeout(() => checkInviteCode(codeInput.value.trim()), 300);
        });

        document.getElementById('teamSelect').addEventListener('change', (e) => {
            if (!lockedTeamAccountId) {
                selectedAccountId = parseInt(e.target.value) || null;
                renderTeamAccounts();
            }
        });

        function showMessage(text, isError = false) {
            message.textContent = text;
            // æ›´æ–°ä¸º Bootstrap alert ç±»
            message.className = 'alert ' + (isError ? 'alert-danger' : 'alert-success');
            message.classList.remove('hidden');
        }

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const token = getToken();
            if (!token) {
                showMessage('è¯·å…ˆç™»å½•', true);
                return;
            }

            const code = codeInput.value.trim();
            const email = document.getElementById('email').value.trim();
            const teamAccountId = lockedTeamAccountId || selectedAccountId;

            if (!teamAccountId) {
                showMessage('è¯·é€‰æ‹©è½¦ä½', true);
                return;
            }

            let turnstileToken = '';
            if (turnstileSiteKey && window.turnstile && turnstileWidgetId !== null) {
                turnstileToken = window.turnstile.getResponse(turnstileWidgetId);
                if (!turnstileToken) {
                    showMessage('è¯·å®ŒæˆäººæœºéªŒè¯', true);
                    return;
                }
            }

            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>å‘é€ä¸­...';
            message.classList.add('hidden');

            try {
                const res = await fetch('/api/invite/use', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + token
                    },
                    body: JSON.stringify({ code, email, teamAccountId, turnstileToken })
                });
                const data = await res.json();

                if (res.ok) {
                    document.getElementById('formSection').classList.add('hidden');
                    document.getElementById('successSection').classList.remove('hidden');
                    document.getElementById('successEmail').textContent = email;
                    loadTeamAccounts();
                } else {
                    showMessage(data.error || 'æäº¤å¤±è´¥', true);
                    if (window.turnstile && turnstileWidgetId !== null) {
                        window.turnstile.reset(turnstileWidgetId);
                    }
                }
            } catch (err) {
                showMessage('ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•', true);
                if (window.turnstile && turnstileWidgetId !== null) {
                    window.turnstile.reset(turnstileWidgetId);
                }
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'å‘é€é‚€è¯·';
            }
        });

        function hideLoading() {
            const overlay = document.getElementById('loadingOverlay');
            overlay.classList.add('fade-out');
            setTimeout(() => overlay.remove(), 300);
        }

        // å¯åŠ¨
        init().then(hideLoading).catch(hideLoading);
        setInterval(loadTeamAccounts, 5000);
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>