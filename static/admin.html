<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®¡ç†åå°</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='50' cy='50' r='45' fill='%232563eb' stroke='%231d4ed8' stroke-width='4'/><text x='50' y='68' font-size='50' font-weight='bold' fill='white' text-anchor='middle' font-family='Arial'>W</text></svg>">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        :root {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            font-size: 14px;
            --bg: #f1f5f9;
            --card: #ffffff;
            --border: #e5e7eb;
            --text: #0f172a;
            --muted: #64748b;
            --primary: #2563eb;
            --danger: #dc2626;
            --success: #16a34a;
            --table-bg: #fafafa;
            --input-bg: #fff;
            --hover-bg: #f1f5f9;
        }
        [data-theme="dark"] {
            --bg: #0f172a;
            --card: #1e293b;
            --border: #334155;
            --text: #f1f5f9;
            --muted: #94a3b8;
            --table-bg: #1e293b;
            --input-bg: #334155;
            --hover-bg: #334155;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { background: var(--bg); min-height: 100vh; color: var(--text); }
        
        .page { max-width: 1000px; margin: 0 auto; padding: 1.5rem; }
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border);
        }
        .page-header h1 { font-size: 1.6rem; font-weight: 700; }
        .page-header .actions { display: flex; gap: 0.5rem; }
        
        /* Notion é£æ ¼ tabs */
        .tabs {
            display: flex;
            gap: 0.25rem;
            margin-bottom: 1.5rem;
            border-bottom: 1px solid var(--border);
            padding-bottom: 0.5rem;
        }
        .tab {
            padding: 0.4rem 0.8rem;
            border-radius: 6px;
            font-weight: 500;
            font-size: 0.9rem;
            background: transparent;
            border: none;
            cursor: pointer;
            color: var(--muted);
        }
        .tab:hover { background: var(--hover-bg); color: var(--text); }
        .tab.active { background: var(--primary); color: #fff; }
        
        .section { display: none; }
        .section.active { display: block; }
        
        /* ç»Ÿè®¡å¡ç‰‡ */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        .stat-card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1rem;
        }
        .stat-card .label { font-size: 0.85rem; color: var(--muted); }
        .stat-card .value { font-size: 1.8rem; font-weight: 700; }
        
        /* è¡¨æ ¼ */
        .table-container {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 8px;
            overflow: hidden;
        }
        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--border);
            background: var(--table-bg);
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        .table-header .title { font-weight: 600; }
        .table-actions { display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap; }
        table { width: 100%; border-collapse: collapse; }
        th, td {
            padding: 0.6rem 1rem;
            text-align: left;
            border-bottom: 1px solid var(--border);
            font-size: 0.9rem;
        }
        th { background: var(--table-bg); font-weight: 600; color: var(--muted); font-size: 0.8rem; }
        tr:hover td { background: var(--hover-bg); }
        
        .badge {
            display: inline-block;
            padding: 0.2rem 0.6rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        .badge.available { background: #dcfce7; color: #166534; }
        .badge.used { background: #fee2e2; color: #991b1b; }
        .badge.enabled { background: #dbeafe; color: #1e40af; }
        .badge.disabled { background: #f3f4f6; color: #6b7280; }
        
        .code {
            font-family: ui-monospace, SFMono-Regular, Menlo, monospace;
            font-weight: 600;
            letter-spacing: 0.05em;
            background: var(--hover-bg);
            padding: 0.15rem 0.4rem;
            border-radius: 4px;
        }
        
        .btn {
            padding: 0.4rem 0.8rem;
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: 500;
            border: none;
            cursor: pointer;
        }
        .btn-primary { background: var(--primary); color: #fff; }
        .btn-primary:hover { background: #1d4ed8; }
        .btn-ghost { background: transparent; color: var(--text); border: 1px solid var(--border); }
        .btn-ghost:hover { background: var(--hover-bg); }
        .btn-danger { background: transparent; color: var(--danger); }
        .btn-danger:hover { background: #fef2f2; }
        .btn-success { background: var(--success); color: #fff; }
        .btn-sm { padding: 0.25rem 0.5rem; font-size: 0.8rem; }
        
        input, select {
            padding: 0.4rem 0.6rem;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 0.9rem;
            background: var(--input-bg);
            color: var(--text);
        }
        input:focus, select:focus {
            outline: none;
            border-color: var(--primary);
        }
        
        /* ç™»å½• */
        #loginSection {
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .login-container {
            max-width: 320px;
            width: 90%;
            padding: 2rem;
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 12px;
        }
        .login-container h2 { margin-bottom: 1.5rem; text-align: center; }
        .login-container input { width: 100%; padding: 0.75rem; margin-bottom: 1rem; }
        .login-container button { width: 100%; padding: 0.75rem; }
        .login-error { color: var(--danger); font-size: 0.85rem; margin-top: 0.5rem; text-align: center; }
        
        .hidden { display: none !important; }
        .text-muted { color: var(--muted); }
        .empty-state { text-align: center; padding: 2rem; color: var(--muted); }
        
        /* ç¼–è¾‘è¡¨å• */
        .edit-form {
            margin-top: 1rem;
            padding: 1rem;
            background: var(--table-bg);
            border: 1px solid var(--border);
            border-radius: 8px;
        }
        .edit-form h3 { margin-bottom: 1rem; font-size: 1rem; }
        .form-row { display: flex; gap: 0.75rem; margin-bottom: 0.75rem; flex-wrap: wrap; }
        .form-row label { display: flex; flex-direction: column; gap: 0.25rem; flex: 1; min-width: 150px; }
        .form-row label span { font-size: 0.85rem; color: var(--muted); }
        .form-actions { display: flex; gap: 0.5rem; justify-content: flex-end; margin-top: 1rem; }
        
        a { color: var(--primary); text-decoration: none; }
        
        /* åŠ è½½åŠ¨ç”» */
        .loading-overlay {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: var(--bg);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.3s ease;
        }
        .loading-overlay.fade-out { opacity: 0; pointer-events: none; }
        .logo-container { width: 60px; height: 60px; }
        .tech-stroke {
            fill: none;
            stroke: var(--primary);
            stroke-width: 2;
            stroke-linecap: round;
            filter: drop-shadow(0 0 2px var(--primary));
        }
        .ring-group { transform-origin: 50px 50px; animation: spin 2s linear infinite; }
        .draw-path { stroke-dasharray: 100; stroke-dashoffset: 100; animation: draw 0.8s ease-out forwards; }
        .center-circle { animation: pop 0.3s ease forwards 0.5s; opacity: 0; transform-origin: 50px 50px; fill: var(--bg); }
        @keyframes draw { to { stroke-dashoffset: 0; } }
        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes pop { to { opacity: 1; } }
        
        /* Toggle Switch */
        .toggle-switch {
            position: relative;
            width: 50px;
            height: 26px;
            flex-shrink: 0;
        }
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: var(--border);
            transition: 0.3s;
            border-radius: 26px;
        }
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
        }
        .toggle-switch input:checked + .toggle-slider {
            background-color: var(--primary);
        }
        .toggle-switch input:checked + .toggle-slider:before {
            transform: translateX(24px);
        }
    </style>
</head>
<body>
    <!-- åŠ è½½åŠ¨ç”» -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="logo-container">
            <svg viewBox="0 0 100 100">
                <defs><path id="petal" d="M40,22 L60,22 L62,24 L60,26 L40,26 L38,24 Z" /></defs>
                <g class="ring-group">
                    <use href="#petal" class="tech-stroke draw-path" transform="rotate(0, 50, 50)" />
                    <use href="#petal" class="tech-stroke draw-path" transform="rotate(60, 50, 50)" style="animation-delay:.1s" />
                    <use href="#petal" class="tech-stroke draw-path" transform="rotate(120, 50, 50)" style="animation-delay:.2s" />
                    <use href="#petal" class="tech-stroke draw-path" transform="rotate(180, 50, 50)" style="animation-delay:.3s" />
                    <use href="#petal" class="tech-stroke draw-path" transform="rotate(240, 50, 50)" style="animation-delay:.4s" />
                    <use href="#petal" class="tech-stroke draw-path" transform="rotate(300, 50, 50)" style="animation-delay:.5s" />
                </g>
                <circle class="center-circle tech-stroke" cx="50" cy="50" r="8" stroke-width="2" />
            </svg>
        </div>
    </div>

    <!-- ç™»å½• -->
    <div id="loginSection">
        <div class="login-container">
            <h2><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16" style="vertical-align: -3px; margin-right: 6px;"><path fill-rule="evenodd" d="M12.096 6.223A4.92 4.92 0 0 0 13 5.698V7c0 .289-.213.654-.753 1.007a4.493 4.493 0 0 1 1.753.25V4c0-1.007-.875-1.755-1.904-2.223C11.022 1.289 9.573 1 8 1s-3.022.289-4.096.777C2.875 2.245 2 2.993 2 4v9c0 1.007.875 1.755 1.904 2.223C4.978 15.71 6.427 16 8 16c.536 0 1.058-.034 1.555-.097a4.525 4.525 0 0 1-.813-.927C8.5 14.992 8.252 15 8 15c-1.464 0-2.766-.27-3.682-.687C3.356 13.875 3 13.373 3 13v-1.302c.271.202.58.378.904.525C4.978 12.71 6.427 13 8 13h.027a4.552 4.552 0 0 1 0-1H8c-1.464 0-2.766-.27-3.682-.687C3.356 10.875 3 10.373 3 10V8.698c.271.202.58.378.904.525C4.978 9.71 6.427 10 8 10c.262 0 .52-.008.774-.024a4.525 4.525 0 0 1 1.102-1.132C9.298 8.944 8.666 9 8 9c-1.464 0-2.766-.27-3.682-.687C3.356 7.875 3 7.373 3 7V5.698c.271.202.58.378.904.525C4.978 6.711 6.427 7 8 7s3.022-.289 4.096-.777ZM3 4c0-.374.356-.875 1.318-1.313C5.234 2.271 6.536 2 8 2s2.766.27 3.682.687C12.644 3.125 13 3.627 13 4c0 .374-.356.875-1.318 1.313C10.766 5.729 9.464 6 8 6s-2.766-.27-3.682-.687C3.356 4.875 3 4.373 3 4Z"/><path fill-rule="evenodd" d="M11.886 9.46c.18-.613 1.048-.613 1.229 0l.043.148a.64.64 0 0 0 .921.382l.136-.074c.561-.306 1.175.308.87.869l-.075.136a.64.64 0 0 0 .382.92l.149.045c.612.18.612 1.048 0 1.229l-.15.043a.64.64 0 0 0-.38.921l.074.136c.305.561-.309 1.175-.87.87l-.136-.075a.64.64 0 0 0-.92.382l-.045.149c-.18.612-1.048.612-1.229 0l-.043-.15a.64.64 0 0 0-.921-.38l-.136.074c-.561.305-1.175-.309-.87-.87l.075-.136a.64.64 0 0 0-.382-.92l-.148-.045c-.613-.18-.613-1.048 0-1.229l.148-.043a.64.64 0 0 0 .382-.921l-.074-.136c-.306-.561.308-1.175.869-.87l.136.075a.64.64 0 0 0 .92-.382l.045-.148ZM14 12.5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0Z"/></svg>ç®¡ç†å‘˜ç™»å½•</h2>
            <input type="password" id="password" placeholder="è¾“å…¥ç®¡ç†å¯†ç " autofocus>
            <input type="text" id="totpCode" class="hidden" placeholder="éªŒè¯ç  (6ä½æ•°å­—)" maxlength="6" pattern="[0-9]{6}" inputmode="numeric" autocomplete="one-time-code">
            <button class="btn btn-primary" onclick="login()">ç™»å½•</button>
            <p id="loginError" class="login-error hidden"></p>
        </div>
    </div>

    <!-- ç®¡ç†é¢æ¿ -->
    <div id="adminSection" class="hidden">
        <div class="page">
            <header class="page-header">
                <h1><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align: -3px; margin-right: 6px;"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>ç®¡ç†åå°</h1>
                <div class="actions">
                    <button class="btn btn-ghost" onclick="toggleTheme()" id="themeBtn"><i class="bi bi-moon"></i></button>
                    <a href="/" class="btn btn-ghost"><i class="bi bi-house-door"></i></a>
                    <button class="btn btn-ghost" onclick="logout()"><i class="bi bi-box-arrow-right"></i></button>
                </div>
            </header>

            <!-- Tabs -->
            <div class="tabs">
                <button class="tab active" onclick="switchTab('accounts')"><svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor" style="vertical-align: -2px; margin-right: 2px;"><path d="M22.2819 9.8211a5.9847 5.9847 0 0 0-.5157-4.9108 6.0462 6.0462 0 0 0-6.5098-2.9A6.0651 6.0651 0 0 0 4.9807 4.1818a5.9847 5.9847 0 0 0-3.9977 2.9 6.0462 6.0462 0 0 0 .7427 7.0966 5.98 5.98 0 0 0 .511 4.9107 6.051 6.051 0 0 0 6.5146 2.9001A5.9847 5.9847 0 0 0 13.2599 24a6.0557 6.0557 0 0 0 5.7718-4.2058 5.9894 5.9894 0 0 0 3.9977-2.9001 6.0557 6.0557 0 0 0-.7475-7.0729zm-9.022 12.6081a4.4755 4.4755 0 0 1-2.8764-1.0408l.1419-.0804 4.7783-2.7582a.7948.7948 0 0 0 .3927-.6813v-6.7369l2.02 1.1686a.071.071 0 0 1 .038.052v5.5826a4.504 4.504 0 0 1-4.4945 4.4944zm-9.6607-4.1254a4.4708 4.4708 0 0 1-.5346-3.0137l.142.0852 4.783 2.7582a.7712.7712 0 0 0 .7806 0l5.8428-3.3685v2.3324a.0804.0804 0 0 1-.0332.0615L9.74 19.9502a4.4992 4.4992 0 0 1-6.1408-1.6464zM2.3408 7.8956a4.485 4.485 0 0 1 2.3655-1.9728V11.6a.7664.7664 0 0 0 .3879.6765l5.8144 3.3543-2.0201 1.1685a.0757.0757 0 0 1-.071 0l-4.8303-2.7865A4.504 4.504 0 0 1 2.3408 7.872zm16.5963 3.8558L13.1038 8.364 15.1192 7.2a.0757.0757 0 0 1 .071 0l4.8303 2.7913a4.4944 4.4944 0 0 1-.6765 8.1042v-5.6772a.79.79 0 0 0-.407-.667zm2.0107-3.0231l-.142-.0852-4.7735-2.7818a.7759.7759 0 0 0-.7854 0L9.409 9.2297V6.8974a.0662.0662 0 0 1 .0284-.0615l4.8303-2.7866a4.4992 4.4992 0 0 1 6.6802 4.66zM8.3065 12.863l-2.02-1.1638a.0804.0804 0 0 1-.038-.0567V6.0742a4.4992 4.4992 0 0 1 7.3757-3.4537l-.142.0805L8.704 5.459a.7948.7948 0 0 0-.3927.6813zm1.0976-2.3654l2.602-1.4998 2.6069 1.4998v2.9994l-2.5974 1.4997-2.6067-1.4997Z"/></svg> Team è½¦è´¦å·</button>
                <button class="tab" onclick="switchTab('codes')"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align: -2px; margin-right: 2px;"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg> é‚€è¯·ç </button>
                <button class="tab" onclick="switchTab('users')"><i class="bi bi-people" style="margin-right: 2px;"></i> ç”¨æˆ·</button>
                <button class="tab" onclick="switchTab('queue')"><i class="bi bi-hourglass-split" style="margin-right: 2px;"></i> é˜Ÿåˆ—</button>
                <button class="tab" onclick="switchTab('cooldown')"><i class="bi bi-clock-history" style="margin-right: 2px;"></i> å†·å´</button>
                <button class="tab" onclick="switchTab('monitor')"><i class="bi bi-speedometer2" style="margin-right: 2px;"></i> ç›‘æ§</button>
                <button class="tab" onclick="switchTab('settings')"><i class="bi bi-gear" style="margin-right: 2px;"></i> è®¾ç½®</button>
            </div>

            <!-- è½¦è´¦å·ç®¡ç† -->
            <div id="accountsSection" class="section active">
                <div class="stats-grid" id="accountStats"></div>
                
                <div class="table-container">
                    <div class="table-header">
                        <span class="title">è½¦è´¦å·åˆ—è¡¨</span>
                        <div class="table-actions">
                            <button class="btn btn-primary" onclick="showAddAccount()">+ æ·»åŠ è½¦è´¦å·</button>
                            <button class="btn btn-ghost" onclick="syncAllAccounts()">åŒæ­¥</button>
                        </div>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>åç§°</th>
                                <th>å·²ç”¨/æ€»å¸­ä½</th>
                                <th>å¾…å¤„ç†</th>
                                <th>æœ€ååŒæ­¥</th>
                                <th>çŠ¶æ€</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="accountList"></tbody>
                    </table>
                    <div id="accountForm" class="edit-form hidden"></div>
                </div>
            </div>

            <!-- é‚€è¯·ç ç®¡ç† -->
            <div id="codesSection" class="section">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="label">æ€»é‚€è¯·ç </div>
                        <div class="value" id="statTotal">-</div>
                    </div>
                    <div class="stat-card">
                        <div class="label">å·²ä½¿ç”¨</div>
                        <div class="value" id="statUsed">-</div>
                    </div>
                    <div class="stat-card">
                        <div class="label">å¯ç”¨</div>
                        <div class="value" id="statAvailable">-</div>
                    </div>
                </div>

                <div class="table-container">
                    <div class="table-header">
                        <span class="title">é‚€è¯·ç åˆ—è¡¨</span>
                        <div class="table-actions">
                            <input type="number" id="codeCount" value="1" min="1" max="50" style="width: 60px;">
                            <select id="codeTeamAccount" style="min-width: 120px;">
                                <option value="">ä¸ç»‘å®šè½¦ä½</option>
                            </select>
                            <button class="btn btn-primary" onclick="generateCodes()">ç”Ÿæˆ</button>
                            <button class="btn btn-danger" onclick="clearAllCodes()">åˆ é™¤æ‰€æœ‰</button>
                            <button class="btn btn-ghost" onclick="loadCodes()">åˆ·æ–°</button>
                        </div>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>é‚€è¯·ç </th>
                                <th>ç»‘å®šè½¦ä½</th>
                                <th>çŠ¶æ€</th>
                                <th>ä½¿ç”¨é‚®ç®±</th>
                                <th>ä½¿ç”¨ç”¨æˆ·</th>
                                <th>åˆ›å»ºæ—¶é—´</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="codeList"></tbody>
                    </table>
                </div>
            </div>

            <!-- ç”¨æˆ·åˆ—è¡¨ -->
            <div id="usersSection" class="section">
                <div class="table-container">
                    <div class="table-header">
                        <span class="title">ç”¨æˆ·åˆ—è¡¨ <span class="text-muted" style="font-weight: normal; font-size: 0.85rem;">(<span id="userTotalCount">0</span> äºº)</span></span>
                        <div class="table-actions">
                            <button class="btn btn-warning" onclick="clearNonTL3Users()">åˆ é™¤éTL3</button>
                            <button class="btn btn-danger" onclick="clearAllUsers()">åˆ é™¤æ‰€æœ‰</button>
                            <button class="btn btn-ghost" onclick="loadUsers()">åˆ·æ–°</button>
                        </div>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>ç”¨æˆ·å</th>
                                <th>åç§°</th>
                                <th>ä¿¡ä»»ç­‰çº§</th>
                                <th>å·²ç”¨é‚€è¯·</th>
                                <th>é¦–æ¬¡ç™»å½•</th>
                                <th>æœ€åç™»å½•</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="userList"></tbody>
                    </table>
                    <div id="userForm" class="edit-form hidden"></div>
                </div>
            </div>

            <!-- æ’é˜Ÿé˜Ÿåˆ— -->
            <div id="queueSection" class="section">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="label">æ’é˜Ÿä¸­</div>
                        <div class="value" id="statQueueWaiting">-</div>
                    </div>
                    <div class="stat-card">
                        <div class="label">å·²é€šçŸ¥</div>
                        <div class="value" id="statQueueNotified">-</div>
                    </div>
                    <div class="stat-card">
                        <div class="label">æ€»è®¡</div>
                        <div class="value" id="statQueueTotal">-</div>
                    </div>
                </div>

                <div class="table-container">
                    <div class="table-header">
                        <span class="title">æ’é˜Ÿåˆ—è¡¨</span>
                        <div class="table-actions">
                            <button class="btn btn-danger" onclick="clearAllQueue()">åˆ é™¤æ‰€æœ‰</button>
                            <button class="btn btn-danger" onclick="clearNotifiedQueue()">æ¸…é™¤å·²é€šçŸ¥</button>
                            <button class="btn btn-ghost" onclick="loadQueue()">åˆ·æ–°</button>
                        </div>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>ç”¨æˆ·</th>
                                <th>é‚®ç®±</th>
                                <th>çŠ¶æ€</th>
                                <th>æ’é˜Ÿæ—¶é—´</th>
                                <th>é€šçŸ¥æ—¶é—´</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="queueList"></tbody>
                    </table>
                </div>
            </div>

            <!-- å†·å´ç”¨æˆ· -->
            <div id="cooldownSection" class="section">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="label">å†·å´ä¸­</div>
                        <div class="value" id="statCooldownCount">-</div>
                    </div>
                </div>

                <div class="table-container">
                    <div class="table-header">
                        <span class="title">å†·å´ç”¨æˆ·åˆ—è¡¨</span>
                        <div class="table-actions">
                            <button class="btn btn-danger" onclick="clearAllCooldown()">æ¸…é™¤æ‰€æœ‰å†·å´</button>
                            <button class="btn btn-ghost" onclick="loadCooldownUsers()">åˆ·æ–°</button>
                        </div>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>ç”¨æˆ·</th>
                                <th>ä½¿ç”¨é‚®ç®±</th>
                                <th>ä½¿ç”¨è½¦ä½</th>
                                <th>ä½¿ç”¨æ—¶é—´</th>
                                <th>å†·å´ç»“æŸ</th>
                                <th>å‰©ä½™å¤©æ•°</th>
                            </tr>
                        </thead>
                        <tbody id="cooldownList"></tbody>
                    </table>
                </div>
            </div>

            <!-- å‘è½¦ç›‘æ§ -->
            <div id="monitorSection" class="section">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="label">æ’é˜Ÿäººæ•°</div>
                        <div class="value" id="monQueueCount">-</div>
                    </div>
                    <div class="stat-card">
                        <div class="label">å¯ç”¨ç©ºä½</div>
                        <div class="value" id="monAvailableSlots">-</div>
                    </div>
                    <div class="stat-card">
                        <div class="label">å¾…ç”¨é‚€è¯·ç </div>
                        <div class="value" id="monPendingCodes">-</div>
                    </div>
                    <div class="stat-card">
                        <div class="label">å‘è½¦çŠ¶æ€</div>
                        <div class="value" id="monStatus" style="font-size: 1rem;">-</div>
                    </div>
                </div>

                <!-- çŠ¶æ€é¢æ¿ -->
                <div class="table-container" style="margin-bottom: 1rem;">
                    <div class="table-header">
                        <span class="title"><i class="bi bi-activity" style="margin-right: 4px;"></i> å®æ—¶çŠ¶æ€</span>
                        <div class="table-actions">
                            <span class="text-muted" id="monDbType"></span>
                            <span class="text-muted" id="monTestMode"></span>
                            <select id="dispatchModeSelect" onchange="setDispatchMode(this.value)" style="padding: 0.3rem 0.5rem; border-radius: 4px; border: 1px solid var(--border); font-size: 0.85rem;">
                                <option value="auto">è‡ªåŠ¨æ¨¡å¼</option>
                                <option value="manual">æ‰‹åŠ¨æ¨¡å¼</option>
                            </select>
                            <button class="btn btn-primary" onclick="forceDispatch()"><i class="bi bi-send"></i> å¼ºåˆ¶å‘è½¦</button>
                            <button class="btn btn-ghost" onclick="loadMonitor()"><i class="bi bi-arrow-clockwise"></i></button>
                        </div>
                    </div>
                    <div style="padding: 1rem;">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                            <div>
                                <div class="text-muted" style="font-size: 0.8rem;">å‘è½¦æ¡ä»¶</div>
                                <div id="monCondition" style="font-weight: 600;">-</div>
                            </div>
                            <div>
                                <div class="text-muted" style="font-size: 0.8rem;">é‚€è¯·ç è¿‡æœŸå€’è®¡æ—¶</div>
                                <div id="monExpireCountdown" style="font-weight: 600; color: var(--warning);">-</div>
                            </div>
                            <div>
                                <div class="text-muted" style="font-size: 0.8rem;">è½®è¯¢é—´éš”</div>
                                <div id="monSyncInterval" style="font-weight: 600;">-</div>
                            </div>
                            <div>
                                <div class="text-muted" style="font-size: 0.8rem;">æ‰¹æ¬¡å†·å´æ—¶é—´</div>
                                <div id="monPollWait" style="font-weight: 600;">-</div>
                            </div>
                            <div>
                                <div class="text-muted" style="font-size: 0.8rem;">æœ€ååŒæ­¥</div>
                                <div id="monLastSync" style="font-weight: 600;">-</div>
                            </div>
                            <div>
                                <div class="text-muted" style="font-size: 0.8rem;">æœ€åå‘è½¦</div>
                                <div id="monLastBatch" style="font-weight: 600;">-</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- è½¦ä½çŠ¶æ€ -->
                <div class="table-container">
                    <div class="table-header">
                        <span class="title"><i class="bi bi-car-front" style="margin-right: 4px;"></i> è½¦ä½çŠ¶æ€</span>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>è½¦ä½</th>
                                <th>æ€»å¸­ä½</th>
                                <th>å·²ç”¨</th>
                                <th>å¾…å¤„ç†</th>
                                <th>å¾…ç”¨ç </th>
                                <th>å¯ç”¨</th>
                                <th>æœ€ååŒæ­¥</th>
                            </tr>
                        </thead>
                        <tbody id="monTeamList"></tbody>
                    </table>
                </div>

                <!-- å‘è½¦è®¾ç½® -->
                <div class="table-container" style="margin-top: 1rem;">
                    <div class="table-header">
                        <span class="title"><i class="bi bi-sliders" style="margin-right: 4px;"></i> å‘è½¦è®¾ç½®</span>
                    </div>
                    <div style="padding: 1.5rem;">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem;">
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem;">
                                    <span style="font-weight: 600;">é‚€è¯·ç æœ‰æ•ˆæ—¶é—´</span>
                                    <span class="text-muted" style="font-size: 0.85rem; margin-left: 0.5rem;">å‘å‡ºåå¤šä¹…è¿‡æœŸ</span>
                                </label>
                                <div style="display: flex; gap: 0.5rem; align-items: center;">
                                    <select id="inviteCodeExpireSelect" style="padding: 0.5rem; min-width: 120px;">
                                        <option value="300">5 åˆ†é’Ÿ</option>
                                        <option value="600">10 åˆ†é’Ÿ</option>
                                        <option value="900">15 åˆ†é’Ÿ</option>
                                        <option value="1800">30 åˆ†é’Ÿ</option>
                                        <option value="3600">1 å°æ—¶</option>
                                        <option value="7200">2 å°æ—¶</option>
                                    </select>
                                    <button class="btn btn-primary" onclick="saveDispatchSettings()">ä¿å­˜</button>
                                </div>
                                <div class="text-muted" style="font-size: 0.85rem; margin-top: 0.5rem;">å½“å‰: <span id="currentInviteExpire">30 åˆ†é’Ÿ</span></div>
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem;">
                                    <span style="font-weight: 600;">å‘è½¦äººæ•°è¦æ±‚</span>
                                    <span class="text-muted" style="font-size: 0.85rem; margin-left: 0.5rem;">æ’é˜Ÿè¾¾åˆ°å¤šå°‘äººæ‰å‘è½¦</span>
                                </label>
                                <div style="display: flex; gap: 0.5rem; align-items: center;">
                                    <input type="number" id="dispatchMinPeopleInput" min="0" value="0" style="width: 80px; padding: 0.5rem;">
                                    <span class="text-muted">äºº</span>
                                    <button class="btn btn-primary" onclick="saveDispatchSettings()">ä¿å­˜</button>
                                </div>
                                <div class="text-muted" style="font-size: 0.85rem; margin-top: 0.5rem;">0 = ä½¿ç”¨å½“å‰ç©ºä½æ•° (<span id="currentAvailableSlots">-</span> ä½)</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- è®¾ç½® -->
            <div id="settingsSection" class="section">
                <div class="table-container">
                    <div class="table-header">
                        <span class="title"><i class="bi bi-door-open" style="margin-right: 4px;"></i> å€™è½¦å®¤è®¾ç½®</span>
                    </div>
                    <div style="padding: 1.5rem;">
                        <div style="display: flex; flex-direction: column; gap: 1.5rem; max-width: 400px;">
                            <div>
                                <div id="waitingRoomStatus" style="margin-bottom: 0.75rem; font-size: 0.9rem;">
                                    å½“å‰å€™è½¦å®¤çŠ¶æ€: <span id="waitingRoomStatusText" style="font-weight: 600; color: var(--danger);">å…³</span>
                                </div>
                                <label style="display: flex; align-items: center; gap: 0.75rem; cursor: pointer;">
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="waitingRoomEnabled" onchange="saveWaitingRoomSettings()">
                                        <span class="toggle-slider"></span>
                                    </label>
                                    <div>
                                        <div style="font-weight: 600;">å¼€æ”¾å€™è½¦å®¤</div>
                                        <div class="text-muted" style="font-size: 0.85rem;">å…³é—­åç”¨æˆ·æ— æ³•è¿›å…¥å€™è½¦å®¤æ’é˜Ÿ</div>
                                    </div>
                                </label>
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem;">
                                    <span style="font-weight: 600;">æ’é˜Ÿäººæ•°ä¸Šé™</span>
                                </label>
                                <div style="display: flex; gap: 0.5rem; align-items: center;">
                                    <input type="number" id="waitingRoomMaxQueue" min="0" value="0" style="width: 100px; padding: 0.5rem;">
                                    <span class="text-muted">äºº</span>
                                    <button class="btn btn-primary" onclick="saveWaitingRoomSettings()">ä¿å­˜</button>
                                </div>
                                <div class="text-muted" style="font-size: 0.85rem; margin-top: 0.5rem;">å½“å‰æ’é˜Ÿ: <span id="currentQueueCount">-</span> äºº</div>
                            </div>
                            <div style="border-top: 1px solid var(--border); padding-top: 1.5rem; margin-top: 0.5rem;">
                                <label style="display: block; margin-bottom: 0.5rem;">
                                    <span style="font-weight: 600;">å®šæ—¶å¼€æ”¾</span>
                                    <span class="text-muted" style="font-size: 0.85rem; margin-left: 0.5rem;">è®¾ç½®å€™è½¦å®¤è‡ªåŠ¨å¼€æ”¾æ—¶é—´ï¼ˆä¸Šæµ·æ—¶é—´ï¼‰</span>
                                </label>
                                <div style="display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap; margin-bottom: 0.75rem;">
                                    <input type="datetime-local" id="scheduledOpenTime" style="padding: 0.5rem;">
                                    <input type="number" id="scheduledMaxQueue" min="0" placeholder="äººæ•°ä¸Šé™" style="padding: 0.5rem; width: 100px;" title="å¼€æ”¾æ—¶è‡ªåŠ¨è®¾ç½®çš„äººæ•°ä¸Šé™">
                                    <span class="text-muted">äºº</span>
                                    <button class="btn btn-primary" onclick="addScheduledOpen()">æ·»åŠ </button>
                                    <button class="btn btn-danger" onclick="clearAllScheduledOpens()">æ¸…é™¤å…¨éƒ¨</button>
                                </div>
                                <div id="scheduledOpenList" style="margin-top: 0.75rem;"></div>
                                <div class="text-muted" style="font-size: 0.8rem; margin-top: 0.5rem;">ğŸ’¡ è¾¾åˆ°äººæ•°ä¸Šé™åå€™è½¦å®¤å°†è‡ªåŠ¨å…³é—­</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- åŒæ­¥è®¾ç½® -->
                <div class="table-container" style="margin-top: 1rem;">
                    <div class="table-header">
                        <span class="title"><i class="bi bi-arrow-repeat" style="margin-right: 4px;"></i> åŒæ­¥è®¾ç½®</span>
                    </div>
                    <div style="padding: 1.5rem;">
                        <div style="display: flex; flex-direction: column; gap: 1.5rem; max-width: 400px;">
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem;">
                                    <span style="font-weight: 600;">è½¦ä½çŠ¶æ€åŒæ­¥é—´éš”</span>
                                    <span class="text-muted" style="font-size: 0.85rem; margin-left: 0.5rem;">è‡ªåŠ¨åŒæ­¥è½¦ä½çŠ¶æ€çš„æ—¶é—´é—´éš”</span>
                                </label>
                                <div style="display: flex; gap: 0.5rem; align-items: center;">
                                    <select id="syncIntervalSelect" style="padding: 0.5rem; min-width: 120px;">
                                        <option value="30">30 ç§’</option>
                                        <option value="60">1 åˆ†é’Ÿ</option>
                                        <option value="300">5 åˆ†é’Ÿ</option>
                                        <option value="900">15 åˆ†é’Ÿ</option>
                                        <option value="1800">30 åˆ†é’Ÿ</option>
                                        <option value="3600">1 å°æ—¶</option>
                                        <option value="7200">2 å°æ—¶</option>
                                    </select>
                                    <button class="btn btn-primary" onclick="saveSyncInterval()">ä¿å­˜</button>
                                </div>
                                <div class="text-muted" style="font-size: 0.85rem; margin-top: 0.5rem;">å·²æ»¡è½¦ä½æ¯ 30 åˆ†é’ŸåŒæ­¥ä¸€æ¬¡</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let accounts = [];

        // ä¸»é¢˜åˆ‡æ¢
        function toggleTheme() {
            const html = document.documentElement;
            const isDark = html.getAttribute('data-theme') === 'dark';
            html.setAttribute('data-theme', isDark ? 'light' : 'dark');
            localStorage.setItem('theme', isDark ? 'light' : 'dark');
            updateThemeIcon();
        }
        function updateThemeIcon() {
            const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
            const btn = document.getElementById('themeBtn');
            if (btn) btn.innerHTML = isDark ? '<i class="bi bi-sun"></i>' : '<i class="bi bi-moon"></i>';
        }
        // åˆå§‹åŒ–ä¸»é¢˜
        (function() {
            const saved = localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
            document.documentElement.setAttribute('data-theme', saved);
            updateThemeIcon();
        })();

        async function api(path, options = {}) {
            const res = await fetch('/api' + path + (path.includes('?') ? '&' : '?') + '_t=' + Date.now(), {
                ...options,
                headers: { 'Content-Type': 'application/json', 'Cache-Control': 'no-cache', ...options.headers }
            });
            return { ok: res.ok, data: await res.json() };
        }

        async function login() {
            const password = document.getElementById('password').value;
            const totpCode = document.getElementById('totpCode').value.trim();
            const { ok, data } = await api('/admin/login', {
                method: 'POST',
                body: JSON.stringify({ password, totpCode })
            });
            if (ok) {
                document.getElementById('loginSection').classList.add('hidden');
                document.getElementById('adminSection').classList.remove('hidden');
                loadAll();
            } else {
                const err = document.getElementById('loginError');
                err.textContent = data.error || 'ç™»å½•å¤±è´¥';
                err.classList.remove('hidden');
            }
        }
        
        // æ£€æŸ¥æ˜¯å¦éœ€è¦ TOTP
        async function checkTotpRequired() {
            try {
                const { data } = await api('/admin/totp-required');
                if (data.required) {
                    document.getElementById('totpCode').classList.remove('hidden');
                }
            } catch {}
        }

        async function logout() {
            await api('/admin/logout', { method: 'POST' });
            location.reload();
        }

        let monitorAutoRefresh = null;
        
        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelector(`.tab[onclick="switchTab('${tab}')"]`).classList.add('active');
            document.getElementById(tab + 'Section').classList.add('active');
            
            // ç›‘æ§é¡µè‡ªåŠ¨åˆ·æ–°
            if (monitorAutoRefresh) {
                clearInterval(monitorAutoRefresh);
                monitorAutoRefresh = null;
            }
            if (tab === 'monitor') {
                loadMonitor();
                monitorAutoRefresh = setInterval(loadMonitor, 5000);
            }
        }

        async function loadAll() {
            // å¹¶è¡ŒåŠ è½½æ‰€æœ‰æ•°æ®ï¼Œæå‡æ€§èƒ½
            await Promise.all([
                loadAccounts(),
                loadCodes(),
                loadStats(),
                loadUsers(),
                loadQueue(),
                loadCooldownUsers(),
                loadMonitor(),
                loadWaitingRoomSettings(),
                loadScheduledOpen(),
                loadSyncInterval()
            ]);
            startMonitorTimer();
        }

        // ========== å€™è½¦å®¤è®¾ç½® ==========
        async function loadWaitingRoomSettings() {
            const { ok, data } = await api('/admin/waiting-room-settings');
            if (!ok) return;
            
            document.getElementById('waitingRoomEnabled').checked = data.enabled;
            document.getElementById('waitingRoomMaxQueue').value = data.maxQueue || 0;
            document.getElementById('currentQueueCount').textContent = data.currentQueue || 0;
            
            // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
            const statusText = document.getElementById('waitingRoomStatusText');
            if (data.enabled) {
                statusText.textContent = 'å¼€';
                statusText.style.color = 'var(--success)';
            } else {
                statusText.textContent = 'å…³';
                statusText.style.color = 'var(--danger)';
            }
        }
        
        async function saveWaitingRoomSettings() {
            const enabled = document.getElementById('waitingRoomEnabled').checked;
            const maxQueue = Math.max(0, parseInt(document.getElementById('waitingRoomMaxQueue').value) || 0);
            
            const { ok, data } = await api('/admin/waiting-room-settings', {
                method: 'POST',
                body: JSON.stringify({ enabled, maxQueue })
            });
            
            if (ok) {
                loadWaitingRoomSettings();
            } else {
                alert(data.error || 'ä¿å­˜å¤±è´¥');
            }
        }
        
        // ========== å®šæ—¶å¼€æ”¾ ==========
        let scheduledOpenTimer = null;
        
        async function loadScheduledOpen() {
            const { ok, data } = await api('/admin/scheduled-open');
            if (!ok) return;
            
            const listEl = document.getElementById('scheduledOpenList');
            const inputEl = document.getElementById('scheduledOpenTime');
            const maxQueueEl = document.getElementById('scheduledMaxQueue');
            
            // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
            if (scheduledOpenTimer) {
                clearTimeout(scheduledOpenTimer);
                scheduledOpenTimer = null;
            }
            
            const schedules = data.schedules || [];
            
            if (schedules.length === 0) {
                listEl.innerHTML = '<div class="text-muted" style="font-size: 0.85rem;">æš‚æ— å®šæ—¶å¼€æ”¾</div>';
                inputEl.value = '';
                maxQueueEl.value = '';
                return;
            }
            
            // æ¸²æŸ“å®šæ—¶åˆ—è¡¨
            let html = '<div style="display: flex; flex-direction: column; gap: 0.5rem;">';
            const now = new Date();
            let nearestDiff = Infinity;
            
            for (const schedule of schedules) {
                const dt = new Date(schedule.scheduledTime);
                const diff = dt - now;
                const timeStr = dt.toLocaleString('zh-CN');
                const maxQueueText = schedule.maxQueue > 0 ? `${schedule.maxQueue} äºº` : 'ä¸é™';
                
                let countdownText = '';
                let statusColor = 'var(--primary)';
                
                if (diff > 0) {
                    const hours = Math.floor(diff / 3600000);
                    const mins = Math.floor((diff % 3600000) / 60000);
                    if (hours > 0) {
                        countdownText = `${hours}å°æ—¶${mins}åˆ†é’Ÿå`;
                    } else {
                        countdownText = `${mins}åˆ†é’Ÿå`;
                    }
                    if (diff < nearestDiff) nearestDiff = diff;
                } else {
                    countdownText = 'å³å°†æ‰§è¡Œ';
                    statusColor = 'var(--success)';
                }
                
                html += `
                    <div style="display: flex; align-items: center; justify-content: space-between; padding: 0.5rem 0.75rem; background: var(--hover-bg); border-radius: 6px;">
                        <div>
                            <span style="font-weight: 600;">â° ${timeStr}</span>
                            <span class="text-muted" style="margin-left: 0.5rem;">ä¸Šé™: ${maxQueueText}</span>
                            <span style="color: ${statusColor}; margin-left: 0.5rem; font-size: 0.85rem;">${countdownText}</span>
                        </div>
                        <button class="btn btn-danger btn-sm" onclick="deleteScheduledOpen(${schedule.id})">åˆ é™¤</button>
                    </div>
                `;
            }
            html += '</div>';
            listEl.innerHTML = html;
            
            // è®¾ç½®å®šæ—¶å™¨åˆ·æ–°
            if (nearestDiff < Infinity && nearestDiff > 0) {
                scheduledOpenTimer = setTimeout(() => {
                    loadWaitingRoomSettings();
                    loadScheduledOpen();
                }, Math.min(nearestDiff + 1000, 60000)); // æœ€å¤š1åˆ†é’Ÿåˆ·æ–°ä¸€æ¬¡
            }
        }
        
        async function addScheduledOpen() {
            const inputVal = document.getElementById('scheduledOpenTime').value;
            const maxQueueVal = document.getElementById('scheduledMaxQueue').value;
            if (!inputVal) {
                alert('è¯·é€‰æ‹©å¼€æ”¾æ—¶é—´');
                return;
            }
            
            // è½¬æ¢ä¸º ISO æ ¼å¼å‘é€
            const dt = new Date(inputVal);
            const { ok, data } = await api('/admin/scheduled-open', {
                method: 'POST',
                body: JSON.stringify({ 
                    scheduledTime: dt.toISOString(),
                    maxQueue: maxQueueVal ? parseInt(maxQueueVal) : 0
                })
            });
            
            if (ok) {
                document.getElementById('scheduledOpenTime').value = '';
                document.getElementById('scheduledMaxQueue').value = '';
                loadScheduledOpen();
            } else {
                alert(data.error || 'æ·»åŠ å¤±è´¥');
            }
        }
        
        async function deleteScheduledOpen(id) {
            const { ok } = await api('/admin/scheduled-open/' + id, {
                method: 'DELETE'
            });
            
            if (ok) {
                loadScheduledOpen();
            } else {
                alert('åˆ é™¤å¤±è´¥');
            }
        }
        
        async function clearAllScheduledOpens() {
            if (!confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰å®šæ—¶å¼€æ”¾å—ï¼Ÿ')) return;
            
            const { ok } = await api('/admin/scheduled-open/clear', {
                method: 'POST'
            });
            
            if (ok) {
                loadScheduledOpen();
            } else {
                alert('æ¸…é™¤å¤±è´¥');
            }
        }

        // ========== åŒæ­¥é—´éš”è®¾ç½® ==========
        async function loadSyncInterval() {
            const { ok, data } = await api('/admin/sync-interval');
            if (!ok) return;
            
            document.getElementById('syncIntervalSelect').value = data.syncInterval || 900;
        }
        
        async function saveSyncInterval() {
            const syncInterval = parseInt(document.getElementById('syncIntervalSelect').value);
            
            const { ok, data } = await api('/admin/sync-interval', {
                method: 'POST',
                body: JSON.stringify({ syncInterval })
            });
            
            if (ok) {
                alert('åŒæ­¥é—´éš”å·²ä¿å­˜');
                loadSyncInterval();
            } else {
                alert(data.error || 'ä¿å­˜å¤±è´¥');
            }
        }

        // ========== è½¦è´¦å· ==========
        async function loadAccounts() {
            const { ok, data } = await api('/admin/team-accounts');
            if (!ok) return;
            accounts = data.accounts || [];
            
            // ç»Ÿè®¡
            const statsHtml = accounts.length > 0 ? accounts.map(acc => `
                <div class="stat-card">
                    <div class="label">${acc.name}</div>
                    <div class="value">${acc.seatsInUse}/${acc.seatsEntitled}</div>
                </div>
            `).join('') : '<div class="stat-card"><div class="label">æš‚æ— è½¦è´¦å·</div></div>';
            document.getElementById('accountStats').innerHTML = statsHtml;
            
            // è¡¨æ ¼
            const tbody = document.getElementById('accountList');
            if (accounts.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="empty-state">æš‚æ— è½¦è´¦å·</td></tr>';
                return;
            }
            tbody.innerHTML = accounts.map(acc => {
                const available = (acc.seatsEntitled || 0) - (acc.seatsInUse || 0) - (acc.pendingInvites || 0);
                const isFull = available <= 0;
                return `
                <tr>
                    <td><strong>${acc.name}</strong></td>
                    <td>${acc.seatsInUse} / ${acc.seatsEntitled}</td>
                    <td>${acc.pendingInvites}</td>
                    <td class="text-muted">${acc.lastSync ? formatTime(acc.lastSync) : '-'}</td>
                    <td>
                        <span class="badge ${acc.enabled ? 'enabled' : 'disabled'}">${acc.enabled ? 'å¯ç”¨' : 'ç¦ç”¨'}</span>
                        ${isFull ? '<span class="badge used" style="margin-left: 4px;">å·²æ»¡</span>' : ''}
                    </td>
                    <td>
                        <button class="btn btn-ghost btn-sm" onclick="editAccount(${acc.id})">ç¼–è¾‘</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteAccount(${acc.id})">åˆ é™¤</button>
                    </td>
                </tr>
            `}).join('');
            
            // æ›´æ–°é‚€è¯·ç ç”Ÿæˆçš„ä¸‹æ‹‰æ¡†
            updateCodeTeamSelect();
        }

        function updateCodeTeamSelect() {
            const select = document.getElementById('codeTeamAccount');
            select.innerHTML = '<option value="">ä¸ç»‘å®šè½¦ä½</option>' + 
                accounts.filter(a => a.enabled).map(a => 
                    `<option value="${a.id}">${a.name}</option>`
                ).join('');
        }

        function showAddAccount() {
            const form = document.getElementById('accountForm');
            form.classList.remove('hidden');
            form.innerHTML = `
                <h3>æ·»åŠ è½¦è´¦å·</h3>
                <div class="form-row">
                    <label><span>åç§°</span><input type="text" id="accName" placeholder="è½¦ä½åç§°"></label>
                    <label><span>æœ€å¤§å¸­ä½</span><input type="number" id="accMaxSeats" value="5" min="1"></label>
                </div>
                <div class="form-row">
                    <label><span>Authorization Token</span><input type="text" id="accToken" placeholder="Bearer token"></label>
                </div>
                <div class="form-row">
                    <label><span>Account ID</span><input type="text" id="accAccountId" placeholder="Account ID"></label>
                </div>
                <div class="form-actions">
                    <button class="btn btn-ghost" onclick="hideAccountForm()">å–æ¶ˆ</button>
                    <button class="btn btn-primary" onclick="saveAccount()">ä¿å­˜</button>
                </div>
            `;
        }

        function editAccount(id) {
            const acc = accounts.find(a => a.id === id);
            if (!acc) return;
            const form = document.getElementById('accountForm');
            form.classList.remove('hidden');
            form.innerHTML = `
                <h3>ç¼–è¾‘è½¦è´¦å·</h3>
                <input type="hidden" id="accId" value="${acc.id}">
                <div class="form-row">
                    <label><span>åç§°</span><input type="text" id="accName" value="${acc.name}"></label>
                    <label><span>æœ€å¤§å¸­ä½</span><input type="number" id="accMaxSeats" value="${acc.maxSeats}" min="1"></label>
                    <label><span>çŠ¶æ€</span>
                        <select id="accEnabled">
                            <option value="1" ${acc.enabled ? 'selected' : ''}>å¯ç”¨</option>
                            <option value="0" ${!acc.enabled ? 'selected' : ''}>ç¦ç”¨</option>
                        </select>
                    </label>
                </div>
                <div class="form-row">
                    <label><span>Authorization Token</span><input type="text" id="accToken" value="${acc.authorizationToken || ''}" placeholder="Bearer token"></label>
                </div>
                <div class="form-row">
                    <label><span>Account ID</span><input type="text" id="accAccountId" value="${acc.accountId || ''}" placeholder="Team/Account ID"></label>
                </div>
                <div class="form-actions">
                    <button class="btn btn-ghost" onclick="hideAccountForm()">å–æ¶ˆ</button>
                    <button class="btn btn-success" onclick="syncAccount(${acc.id})">åŒæ­¥çŠ¶æ€</button>
                    <button class="btn btn-primary" onclick="saveAccount()">ä¿å­˜</button>
                </div>
            `;
        }

        function hideAccountForm() {
            document.getElementById('accountForm').classList.add('hidden');
        }

        async function saveAccount() {
            const id = document.getElementById('accId')?.value;
            const name = document.getElementById('accName').value.trim();
            const maxSeats = parseInt(document.getElementById('accMaxSeats').value) || 5;
            const enabled = document.getElementById('accEnabled')?.value !== '0';
            const authorizationToken = document.getElementById('accToken')?.value.trim() || '';
            const accountId = document.getElementById('accAccountId')?.value.trim() || '';

            if (!name) { alert('è¯·è¾“å…¥åç§°'); return; }

            let res;
            if (id) {
                res = await api(`/admin/team-accounts/${id}`, {
                    method: 'PUT',
                    body: JSON.stringify({ name, maxSeats, enabled, authorizationToken, accountId })
                });
            } else {
                res = await api('/admin/team-accounts', {
                    method: 'POST',
                    body: JSON.stringify({ name, maxSeats, authorizationToken, accountId })
                });
            }
            if (!res.ok) {
                alert(res.data?.error || 'ä¿å­˜å¤±è´¥');
                return;
            }
            hideAccountForm();
            loadAccounts();
        }

        async function syncAccount(id) {
            const { ok, data } = await api(`/admin/team-accounts/${id}/sync`, { method: 'POST' });
            if (ok) {
                alert(`åŒæ­¥æˆåŠŸï¼å·²ç”¨å¸­ä½: ${data.seatsInUse}`);
                loadAccounts();
            } else {
                alert(data.error || 'åŒæ­¥å¤±è´¥');
            }
        }

        async function syncAllAccounts() {
            const { ok, data } = await api('/admin/team-accounts/sync-all', { method: 'POST' });
            if (ok) {
                const msg = data.results.map(r => `${r.name}: ${r.error || r.seatsInUse + 'å¸­'}`).join('\n');
                alert('åŒæ­¥å®Œæˆ:\n' + msg);
                loadAccounts();
            } else {
                alert('åŒæ­¥å¤±è´¥');
            }
        }

        async function deleteAccount(id) {
            if (!confirm('ç¡®å®šåˆ é™¤æ­¤è½¦è´¦å·ï¼Ÿ')) return;
            const { ok, data } = await api(`/admin/team-accounts/${id}`, { method: 'DELETE' });
            if (!ok) { alert(data.error || 'åˆ é™¤å¤±è´¥'); return; }
            loadAccounts();
        }

        // ========== é‚€è¯·ç  ==========
        async function loadStats() {
            const { ok, data } = await api('/admin/stats');
            if (ok) {
                document.getElementById('statTotal').textContent = data.total;
                document.getElementById('statUsed').textContent = data.used;
                document.getElementById('statAvailable').textContent = data.available;
            }
        }

        async function loadCodes() {
            const { ok, data } = await api('/admin/codes');
            const tbody = document.getElementById('codeList');
            
            if (!ok || !data.codes || data.codes.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="empty-state">æš‚æ— é‚€è¯·ç </td></tr>';
                return;
            }
            
            tbody.innerHTML = data.codes.map(c => `
                <tr>
                    <td><span class="code">${c.code}</span></td>
                    <td class="text-muted">${c.team_name || '-'}</td>
                    <td><span class="badge ${c.used ? 'used' : 'available'}">${c.used ? 'å·²ä½¿ç”¨' : 'å¯ç”¨'}</span></td>
                    <td class="text-muted">${c.used_email || '-'}</td>
                    <td class="text-muted">${c.used_username || '-'}</td>
                    <td class="text-muted">${formatTime(c.created_at)}</td>
                    <td>${!c.used ? `<button class="btn btn-danger btn-sm" onclick="deleteCode(${c.id})">åˆ é™¤</button>` : '-'}</td>
                </tr>
            `).join('');
        }

        function formatTime(t) {
            if (!t) return '-';
            return new Date(t).toLocaleString('zh-CN', { month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' });
        }

        async function generateCodes() {
            const count = parseInt(document.getElementById('codeCount').value) || 1;
            const teamAccountId = document.getElementById('codeTeamAccount').value || null;
            const { ok, data } = await api('/admin/codes', {
                method: 'POST',
                body: JSON.stringify({ count, teamAccountId: teamAccountId ? parseInt(teamAccountId) : null })
            });
            if (ok) {
                alert(`å·²ç”Ÿæˆ ${data.created} ä¸ªé‚€è¯·ç :\n\n${data.codes.join('\n')}`);
                loadCodes();
                loadStats();
            }
        }

        async function deleteCode(id) {
            if (!confirm('ç¡®å®šåˆ é™¤æ­¤é‚€è¯·ç ï¼Ÿ')) return;
            await api(`/admin/codes/${id}`, { method: 'DELETE' });
            loadCodes();
            loadStats();
        }

        // ========== ç”¨æˆ· ==========
        let users = [];
        async function loadUsers() {
            const { ok, data } = await api('/admin/users');
            const tbody = document.getElementById('userList');
            
            if (!ok || !data.users || data.users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="empty-state">æš‚æ— ç”¨æˆ·</td></tr>';
                document.getElementById('userTotalCount').textContent = '0';
                return;
            }
            users = data.users;
            document.getElementById('userTotalCount').textContent = users.length;
            tbody.innerHTML = users.map(u => `
                <tr>
                    <td>${u.id}</td>
                    <td><strong>${u.username}</strong></td>
                    <td class="text-muted">${u.name || '-'}</td>
                    <td><span class="badge enabled">TL${u.trust_level}</span></td>
                    <td><span class="badge ${u.has_used ? 'used' : 'available'}">${u.has_used ? 'æ˜¯' : 'å¦'}</span></td>
                    <td class="text-muted">${formatTime(u.created_at)}</td>
                    <td class="text-muted">${formatTime(u.updated_at)}</td>
                    <td>
                        <button class="btn btn-ghost btn-sm" onclick="editUser(${u.id})">ç¼–è¾‘</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteUser(${u.id})">åˆ é™¤</button>
                    </td>
                </tr>
            `).join('');
        }

        function editUser(id) {
            const u = users.find(x => x.id === id);
            if (!u) return;
            const form = document.getElementById('userForm');
            form.classList.remove('hidden');
            form.innerHTML = `
                <h3>ç¼–è¾‘ç”¨æˆ· - ${u.username}</h3>
                <input type="hidden" id="userId" value="${u.id}">
                <div class="form-row">
                    <label style="flex-direction:row;align-items:center;gap:0.5rem;">
                        <input type="checkbox" id="userHasUsed" ${u.has_used ? 'checked' : ''} style="width:auto;">
                        <span>æ˜¯å¦å·²ç”¨</span>
                    </label>
                </div>
                <div class="form-actions">
                    <button class="btn btn-ghost" onclick="hideUserForm()">å–æ¶ˆ</button>
                    <button class="btn btn-primary" onclick="saveUser()">ä¿å­˜</button>
                </div>
            `;
        }

        function hideUserForm() {
            document.getElementById('userForm').classList.add('hidden');
        }

        async function saveUser() {
            const id = document.getElementById('userId').value;
            const hasUsed = document.getElementById('userHasUsed').checked;
            
            const res = await api(`/admin/users/${id}`, {
                method: 'PUT',
                body: JSON.stringify({ hasUsed })
            });
            if (!res.ok) {
                alert(res.data?.error || 'ä¿å­˜å¤±è´¥');
                return;
            }
            hideUserForm();
            loadUsers();
        }

        async function deleteUser(id) {
            if (!confirm('ç¡®å®šåˆ é™¤æ­¤ç”¨æˆ·ï¼Ÿ')) return;
            const res = await api(`/admin/users/${id}`, { method: 'DELETE' });
            if (!res.ok) {
                alert(res.data?.error || 'åˆ é™¤å¤±è´¥');
                return;
            }
            loadUsers();
        }

        // ========== æ’é˜Ÿé˜Ÿåˆ— ==========
        async function loadQueue() {
            const { ok, data } = await api('/admin/queue');
            if (!ok) return;
            
            // æ›´æ–°ç»Ÿè®¡
            document.getElementById('statQueueWaiting').textContent = data.waiting || 0;
            document.getElementById('statQueueNotified').textContent = data.notified || 0;
            document.getElementById('statQueueTotal').textContent = data.total || 0;
            
            const tbody = document.getElementById('queueList');
            if (!data.queue || data.queue.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="empty-state">æš‚æ— æ’é˜Ÿ</td></tr>';
                return;
            }
            
            tbody.innerHTML = data.queue.map(q => `
                <tr>
                    <td>${q.id}</td>
                    <td><strong>${q.username || '-'}</strong>${q.user_name ? `<br><span class="text-muted">${q.user_name}</span>` : ''}</td>
                    <td>${q.email || '-'}</td>
                    <td><span class="badge ${q.notified ? 'used' : 'available'}">${q.notified ? 'å·²é€šçŸ¥' : 'æ’é˜Ÿä¸­'}</span></td>
                    <td class="text-muted">${formatTime(q.created_at)}</td>
                    <td class="text-muted">${q.notified_at ? formatTime(q.notified_at) : '-'}</td>
                    <td>
                        <button class="btn btn-danger btn-sm" onclick="deleteQueueItem(${q.id})">åˆ é™¤</button>
                    </td>
                </tr>
            `).join('');
        }

        async function deleteQueueItem(id) {
            if (!confirm('ç¡®å®šåˆ é™¤æ­¤æ’é˜Ÿè®°å½•ï¼Ÿ')) return;
            const res = await api(`/admin/queue/${id}`, { method: 'DELETE' });
            if (!res.ok) {
                alert(res.data?.error || 'åˆ é™¤å¤±è´¥');
                return;
            }
            loadQueue();
        }

        async function clearNotifiedQueue() {
            if (!confirm('ç¡®å®šæ¸…é™¤æ‰€æœ‰å·²é€šçŸ¥çš„æ’é˜Ÿè®°å½•ï¼Ÿ')) return;
            const res = await api('/admin/queue/clear-notified', { method: 'POST' });
            if (!res.ok) {
                alert(res.data?.error || 'æ¸…é™¤å¤±è´¥');
                return;
            }
            alert(`å·²æ¸…é™¤ ${res.data.deleted} æ¡è®°å½•`);
            loadQueue();
        }

        async function clearAllQueue() {
            if (!confirm('âš ï¸ ç¡®å®šåˆ é™¤æ‰€æœ‰æ’é˜Ÿè®°å½•ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) return;
            const res = await api('/admin/queue/clear-all', { method: 'POST' });
            if (!res.ok) {
                alert(res.data?.error || 'åˆ é™¤å¤±è´¥');
                return;
            }
            alert(`å·²åˆ é™¤ ${res.data.deleted} æ¡è®°å½•`);
            loadQueue();
        }

        async function clearAllUsers() {
            if (!confirm('âš ï¸ ç¡®å®šåˆ é™¤æ‰€æœ‰ç”¨æˆ·ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) return;
            const res = await api('/admin/users/clear-all', { method: 'POST' });
            if (!res.ok) {
                alert(res.data?.error || 'åˆ é™¤å¤±è´¥');
                return;
            }
            alert(`å·²åˆ é™¤ ${res.data.deleted} ä¸ªç”¨æˆ·`);
            loadUsers();
        }
        
        async function clearNonTL3Users() {
            if (!confirm('âš ï¸ ç¡®å®šåˆ é™¤æ‰€æœ‰é TL3 ç”¨æˆ·ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) return;
            const res = await api('/admin/users/clear-non-tl3', { method: 'POST' });
            if (!res.ok) {
                alert(res.data?.error || 'åˆ é™¤å¤±è´¥');
                return;
            }
            alert(`å·²åˆ é™¤ ${res.data.deleted} ä¸ªé TL3 ç”¨æˆ·`);
            loadUsers();
        }

        async function clearAllCodes() {
            if (!confirm('âš ï¸ ç¡®å®šåˆ é™¤æ‰€æœ‰é‚€è¯·ç ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) return;
            const res = await api('/admin/codes/clear-all', { method: 'POST' });
            if (!res.ok) {
                alert(res.data?.error || 'åˆ é™¤å¤±è´¥');
                return;
            }
            alert(`å·²åˆ é™¤ ${res.data.deleted} ä¸ªé‚€è¯·ç `);
            loadCodes();
            loadStats();
        }

        // ========== å†·å´ç”¨æˆ· ==========
        async function loadCooldownUsers() {
            const { ok, data } = await api('/admin/cooldown-users');
            if (!ok) return;
            
            document.getElementById('statCooldownCount').textContent = data.count || 0;
            
            const tbody = document.getElementById('cooldownList');
            if (!data.users || data.users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="empty-state">æš‚æ— å†·å´ç”¨æˆ·</td></tr>';
                return;
            }
            
            tbody.innerHTML = data.users.map(u => `
                <tr>
                    <td><strong>${u.username}</strong>${u.name ? `<br><span class="text-muted">${u.name}</span>` : ''}</td>
                    <td class="text-muted">${u.used_email || '-'}</td>
                    <td class="text-muted">${u.team_name || '-'}</td>
                    <td class="text-muted">${formatTime(u.used_at)}</td>
                    <td class="text-muted">${formatTime(u.cooldown_end)}</td>
                    <td><span class="badge used">${u.days_left} å¤©</span></td>
                </tr>
            `).join('');
        }

        async function clearAllCooldown() {
            if (!confirm('âš ï¸ ç¡®å®šæ¸…é™¤æ‰€æœ‰ç”¨æˆ·çš„å†·å´çŠ¶æ€ï¼Ÿä»–ä»¬å°†å¯ä»¥é‡æ–°æ’é˜Ÿã€‚')) return;
            const res = await api('/admin/cooldown-users/clear-all', { method: 'POST' });
            if (!res.ok) {
                alert(res.data?.error || 'æ¸…é™¤å¤±è´¥');
                return;
            }
            alert(`å·²æ¸…é™¤ ${res.data.updated} ä¸ªç”¨æˆ·çš„å†·å´çŠ¶æ€`);
            loadCooldownUsers();
        }

        // ========== å‘è½¦ç›‘æ§ ==========
        let monitorTimer = null;
        let monitorData = null;
        
        async function loadMonitor() {
            const { ok, data } = await api('/admin/monitor');
            if (!ok) return;
            monitorData = data;
            
            // æ›´æ–°ç»Ÿè®¡å¡ç‰‡
            document.getElementById('monQueueCount').textContent = data.queueCount;
            document.getElementById('monAvailableSlots').textContent = data.availableSlots;
            document.getElementById('monPendingCodes').textContent = data.pendingCodes;
            
            // çŠ¶æ€æ˜¾ç¤º
            const statusEl = document.getElementById('monStatus');
            let statusColor = 'var(--muted)';
            if (data.status === 'ready') statusColor = 'var(--success)';
            else if (data.status === 'waiting') statusColor = 'var(--warning)';
            else if (data.status === 'sending') statusColor = 'var(--primary)';
            else if (data.status === 'error') statusColor = 'var(--danger)';
            statusEl.innerHTML = `<span style="color: ${statusColor}">${data.statusText}</span>`;
            
            // æ•°æ®åº“ç±»å‹æ ‡è¯†
            document.getElementById('monDbType').innerHTML = data.databaseType === 'PostgreSQL'
                ? '<span class="badge enabled">PostgreSQL</span>'
                : '<span class="badge disabled">SQLite</span>';
            
            // æµ‹è¯•æ¨¡å¼æ ‡è¯†
            document.getElementById('monTestMode').innerHTML = data.testMode 
                ? '<span class="badge used">æµ‹è¯•æ¨¡å¼</span>' 
                : '<span class="badge available">æ­£å¼æ¨¡å¼</span>';
            
            // å‘è½¦æ¨¡å¼
            document.getElementById('dispatchModeSelect').value = data.dispatchMode || 'auto';
            
            // å‘è½¦æ¡ä»¶ï¼ˆä½¿ç”¨å®é™…å‘è½¦äººæ•°è¦æ±‚ï¼‰
            const condEl = document.getElementById('monCondition');
            const minRequired = data.dispatchMinActual || data.availableSlots;
            if (data.queueCount >= minRequired && data.availableSlots > 0) {
                condEl.innerHTML = `<span style="color: var(--success)">âœ“ äººæ»¡å‘è½¦ (${data.queueCount} â‰¥ ${minRequired})</span>`;
            } else if (data.availableSlots > 0) {
                condEl.innerHTML = `<span style="color: var(--warning)">ç­‰å¾…äººæ»¡ (${data.queueCount} < ${minRequired})</span>`;
            } else {
                condEl.innerHTML = `<span style="color: var(--muted)">æ— ç©ºä½</span>`;
            }
            
            // è¿‡æœŸå€’è®¡æ—¶
            updateExpireCountdown();
            
            // é…ç½®ä¿¡æ¯
            document.getElementById('monSyncInterval').textContent = `${data.syncInterval} ç§’`;
            document.getElementById('monPollWait').textContent = `${data.pollWaitTime} ç§’`;
            
            // æ—¶é—´ä¿¡æ¯
            document.getElementById('monLastSync').textContent = data.lastSyncTime ? formatTime(data.lastSyncTime) : '-';
            document.getElementById('monLastBatch').textContent = data.lastBatchTime ? formatTime(data.lastBatchTime) : '-';
            
            // å‘è½¦è®¾ç½®
            document.getElementById('inviteCodeExpireSelect').value = data.inviteCodeExpire || 1800;
            document.getElementById('dispatchMinPeopleInput').value = data.dispatchMinPeople || 0;
            document.getElementById('currentAvailableSlots').textContent = data.availableSlots;
            document.getElementById('currentInviteExpire').textContent = formatExpireTime(data.inviteCodeExpire || 1800);
            
            // è½¦ä½åˆ—è¡¨
            const tbody = document.getElementById('monTeamList');
            if (!data.teams || data.teams.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="empty-state">æš‚æ— è½¦ä½</td></tr>';
            } else {
                tbody.innerHTML = data.teams.map(t => `
                    <tr>
                        <td><strong>${t.name}</strong></td>
                        <td>${t.total}</td>
                        <td>${t.inUse}</td>
                        <td>${t.pendingInvites}</td>
                        <td>${t.pendingCodes}</td>
                        <td><span class="badge ${t.available > 0 ? 'available' : 'used'}">${t.available}</span></td>
                        <td class="text-muted">${t.lastSync ? formatTime(t.lastSync) : '-'}</td>
                    </tr>
                `).join('');
            }
        }
        
        function formatExpireTime(seconds) {
            if (seconds >= 3600) return `${seconds / 3600} å°æ—¶`;
            return `${seconds / 60} åˆ†é’Ÿ`;
        }
        
        function updateExpireCountdown() {
            const el = document.getElementById('monExpireCountdown');
            if (!monitorData || !monitorData.expireCountdown) {
                el.textContent = '-';
                el.style.color = 'var(--muted)';
                return;
            }
            
            const remaining = monitorData.expireCountdown;
            const minutes = Math.floor(remaining / 60);
            const seconds = remaining % 60;
            el.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            
            if (remaining < 300) {
                el.style.color = 'var(--danger)';
            } else if (remaining < 600) {
                el.style.color = 'var(--warning)';
            } else {
                el.style.color = 'var(--success)';
            }
        }
        
        async function forceDispatch() {
            if (!confirm('ç¡®å®šè¦å¼ºåˆ¶å‘è½¦å—ï¼Ÿå°†è·³è¿‡äººæ»¡å‘è½¦æ£€æŸ¥ï¼Œç«‹å³ç»™æ’é˜Ÿç”¨æˆ·å‘é€é‚€è¯·ç ã€‚')) return;
            
            const { ok, data } = await api('/admin/send-invite-codes', { method: 'POST' });
            if (ok) {
                alert(data.message || 'å‘è½¦æˆåŠŸ');
                loadMonitor();
                loadQueue();
            } else {
                alert(data.error || 'å‘è½¦å¤±è´¥');
            }
        }
        
        async function setDispatchMode(mode) {
            const { ok, data } = await api('/admin/dispatch-mode', { 
                method: 'POST',
                body: JSON.stringify({ mode })
            });
            if (ok) {
                loadMonitor();
            } else {
                alert(data.error || 'è®¾ç½®å¤±è´¥');
                loadMonitor(); // åˆ·æ–°æ¢å¤åŸå€¼
            }
        }
        
        async function saveDispatchSettings() {
            const inviteCodeExpire = parseInt(document.getElementById('inviteCodeExpireSelect').value);
            const dispatchMinPeople = parseInt(document.getElementById('dispatchMinPeopleInput').value) || 0;
            
            const { ok, data } = await api('/admin/dispatch-settings', {
                method: 'POST',
                body: JSON.stringify({ inviteCodeExpire, dispatchMinPeople })
            });
            
            if (ok) {
                alert('å‘è½¦è®¾ç½®å·²ä¿å­˜');
                loadMonitor();
            } else {
                alert(data.error || 'ä¿å­˜å¤±è´¥');
            }
        }
        
        function startMonitorTimer() {
            if (monitorTimer) clearInterval(monitorTimer);
            monitorTimer = setInterval(() => {
                if (monitorData && monitorData.expireCountdown > 0) {
                    monitorData.expireCountdown--;
                    updateExpireCountdown();
                }
            }, 1000);
        }

        // å›è½¦ç™»å½•
        document.getElementById('password').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                const totpInput = document.getElementById('totpCode');
                if (!totpInput.classList.contains('hidden') && !totpInput.value) {
                    totpInput.focus();
                } else {
                    login();
                }
            }
        });
        document.getElementById('totpCode').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') login();
        });

        function hideLoading() {
            const o = document.getElementById('loadingOverlay');
            if (o) { o.classList.add('fade-out'); setTimeout(() => o.remove(), 300); }
        }

        // æ£€æŸ¥ç™»å½•çŠ¶æ€
        (async () => {
            checkTotpRequired();
            const { ok } = await api('/admin/stats');
            if (ok) {
                document.getElementById('loginSection').classList.add('hidden');
                document.getElementById('adminSection').classList.remove('hidden');
                loadAll();
            }
            hideLoading();
        })();
    </script>
</body>
</html>
